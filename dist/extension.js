module.exports=function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(n,s,function(t){return e[t]}.bind(null,s));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=11)}([function(e,t){e.exports=require("vscode")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(14),s=i(4),o=i(7),r=i(15);t.Source=class{constructor(e,t,i=0,n,s){this.name=e,this.path=t,this.sourceReference=i,n&&(this.origin=n),s&&(this.adapterData=s)}};t.Scope=class{constructor(e,t,i=!1){this.name=e,this.variablesReference=t,this.expensive=i}};t.StackFrame=class{constructor(e,t,i,n=0,s=0){this.id=e,this.source=i,this.line=n,this.column=s,this.name=t}};t.Thread=class{constructor(e,t){this.id=e,this.name=t||"Thread #"+e}};t.Variable=class{constructor(e,t,i=0,n,s){this.name=e,this.value=t,this.variablesReference=i,"number"==typeof s&&(this.namedVariables=s),"number"==typeof n&&(this.indexedVariables=n)}};t.Breakpoint=class{constructor(e,t,i,n){this.verified=e;const s=this;"number"==typeof t&&(s.line=t),"number"==typeof i&&(s.column=i),n&&(s.source=n)}};t.Module=class{constructor(e,t){this.id=e,this.name=t}};t.CompletionItem=class{constructor(e,t,i=0){this.label=e,this.start=t,this.length=i}};class a extends s.Event{constructor(e,t,i){super("stopped"),this.body={reason:e},"number"==typeof t&&(this.body.threadId=t),"string"==typeof i&&(this.body.text=i)}}t.StoppedEvent=a;class c extends s.Event{constructor(e,t){super("continued"),this.body={threadId:e},"boolean"==typeof t&&(this.body.allThreadsContinued=t)}}t.ContinuedEvent=c;class p extends s.Event{constructor(){super("initialized")}}t.InitializedEvent=p;class l extends s.Event{constructor(e){if(super("terminated"),"boolean"==typeof e||e){this.body={restart:e}}}}t.TerminatedEvent=l;class u extends s.Event{constructor(e,t="console",i){super("output"),this.body={category:t,output:e},void 0!==i&&(this.body.data=i)}}t.OutputEvent=u;class h extends s.Event{constructor(e,t){super("thread"),this.body={reason:e,threadId:t}}}t.ThreadEvent=h;class m extends s.Event{constructor(e,t){super("breakpoint"),this.body={reason:e,breakpoint:t}}}t.BreakpointEvent=m;class d extends s.Event{constructor(e,t){super("module"),this.body={reason:e,module:t}}}t.ModuleEvent=d;class g extends s.Event{constructor(e,t){super("loadedSource"),this.body={reason:e,source:t}}}t.LoadedSourceEvent=g;class b extends s.Event{constructor(e){super("capabilities"),this.body={capabilities:e}}}var f;t.CapabilitiesEvent=b,function(e){e[e.User=1]="User",e[e.Telemetry=2]="Telemetry"}(f=t.ErrorDestination||(t.ErrorDestination={}));class E extends n.ProtocolServer{constructor(e,t){super();const i="boolean"==typeof e&&e;this._debuggerLinesStartAt1=i,this._debuggerColumnsStartAt1=i,this._debuggerPathsAreURIs=!1,this._clientLinesStartAt1=!0,this._clientColumnsStartAt1=!0,this._clientPathsAreURIs=!1,this._isServer="boolean"==typeof t&&t,this.on("close",()=>{this.shutdown()}),this.on("error",e=>{this.shutdown()})}setDebuggerPathFormat(e){this._debuggerPathsAreURIs="path"!==e}setDebuggerLinesStartAt1(e){this._debuggerLinesStartAt1=e}setDebuggerColumnsStartAt1(e){this._debuggerColumnsStartAt1=e}setRunAsServer(e){this._isServer=e}static run(e){let t=0;if(process.argv.slice(2).forEach((function(e,i,n){const s=/^--server=(\d{4,5})$/.exec(e);s&&(t=parseInt(s[1],10))})),t>0)console.error("waiting for debug protocol on port "+t),o.createServer(t=>{console.error(">> accepted connection from client"),t.on("end",()=>{console.error(">> client connection closed\n")});const i=new e(!1,!0);i.setRunAsServer(!0),i.start(t,t)}).listen(t);else{const t=new e(!1);process.on("SIGTERM",()=>{t.shutdown()}),t.start(process.stdin,process.stdout)}}shutdown(){this._isServer||this._isRunningInline()||setTimeout(()=>{process.exit(0)},100)}sendErrorResponse(e,t,i,n,s=f.User){let o;"number"==typeof t?(o={id:t,format:i},n&&(o.variables=n),s&f.User&&(o.showUser=!0),s&f.Telemetry&&(o.sendTelemetry=!0)):o=t,e.success=!1,e.message=E.formatPII(o.format,!0,o.variables),e.body||(e.body={}),e.body.error=o,this.sendResponse(e)}runInTerminalRequest(e,t,i){this.sendRequest("runInTerminal",e,t,i)}dispatchRequest(e){const t=new s.Response(e);try{if("initialize"===e.command){var i=e.arguments;if("boolean"==typeof i.linesStartAt1&&(this._clientLinesStartAt1=i.linesStartAt1),"boolean"==typeof i.columnsStartAt1&&(this._clientColumnsStartAt1=i.columnsStartAt1),"path"!==i.pathFormat)this.sendErrorResponse(t,2018,"debug adapter only supports native paths",null,f.Telemetry);else{const e=t;e.body={},this.initializeRequest(e,i)}}else"launch"===e.command?this.launchRequest(t,e.arguments,e):"attach"===e.command?this.attachRequest(t,e.arguments,e):"disconnect"===e.command?this.disconnectRequest(t,e.arguments,e):"terminate"===e.command?this.terminateRequest(t,e.arguments,e):"restart"===e.command?this.restartRequest(t,e.arguments,e):"setBreakpoints"===e.command?this.setBreakPointsRequest(t,e.arguments,e):"setFunctionBreakpoints"===e.command?this.setFunctionBreakPointsRequest(t,e.arguments,e):"setExceptionBreakpoints"===e.command?this.setExceptionBreakPointsRequest(t,e.arguments,e):"configurationDone"===e.command?this.configurationDoneRequest(t,e.arguments,e):"continue"===e.command?this.continueRequest(t,e.arguments,e):"next"===e.command?this.nextRequest(t,e.arguments,e):"stepIn"===e.command?this.stepInRequest(t,e.arguments,e):"stepOut"===e.command?this.stepOutRequest(t,e.arguments,e):"stepBack"===e.command?this.stepBackRequest(t,e.arguments,e):"reverseContinue"===e.command?this.reverseContinueRequest(t,e.arguments,e):"restartFrame"===e.command?this.restartFrameRequest(t,e.arguments,e):"goto"===e.command?this.gotoRequest(t,e.arguments,e):"pause"===e.command?this.pauseRequest(t,e.arguments,e):"stackTrace"===e.command?this.stackTraceRequest(t,e.arguments,e):"scopes"===e.command?this.scopesRequest(t,e.arguments,e):"variables"===e.command?this.variablesRequest(t,e.arguments,e):"setVariable"===e.command?this.setVariableRequest(t,e.arguments,e):"setExpression"===e.command?this.setExpressionRequest(t,e.arguments,e):"source"===e.command?this.sourceRequest(t,e.arguments,e):"threads"===e.command?this.threadsRequest(t,e):"terminateThreads"===e.command?this.terminateThreadsRequest(t,e.arguments,e):"evaluate"===e.command?this.evaluateRequest(t,e.arguments,e):"stepInTargets"===e.command?this.stepInTargetsRequest(t,e.arguments,e):"gotoTargets"===e.command?this.gotoTargetsRequest(t,e.arguments,e):"completions"===e.command?this.completionsRequest(t,e.arguments,e):"exceptionInfo"===e.command?this.exceptionInfoRequest(t,e.arguments,e):"loadedSources"===e.command?this.loadedSourcesRequest(t,e.arguments,e):"dataBreakpointInfo"===e.command?this.dataBreakpointInfoRequest(t,e.arguments,e):"setDataBreakpoints"===e.command?this.setDataBreakpointsRequest(t,e.arguments,e):"readMemory"===e.command?this.readMemoryRequest(t,e.arguments,e):"disassemble"===e.command?this.disassembleRequest(t,e.arguments,e):"cancel"===e.command?this.cancelRequest(t,e.arguments,e):"breakpointLocations"===e.command?this.breakpointLocationsRequest(t,e.arguments,e):this.customRequest(e.command,t,e.arguments,e)}catch(e){this.sendErrorResponse(t,1104,"{_stack}",{_exception:e.message,_stack:e.stack},f.Telemetry)}}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,e.body.supportsRestartRequest=!1,e.body.supportsExceptionOptions=!1,e.body.supportsValueFormattingOptions=!1,e.body.supportsExceptionInfoRequest=!1,e.body.supportTerminateDebuggee=!1,e.body.supportsDelayedStackTraceLoading=!1,e.body.supportsLoadedSourcesRequest=!1,e.body.supportsLogPoints=!1,e.body.supportsTerminateThreadsRequest=!1,e.body.supportsSetExpression=!1,e.body.supportsTerminateRequest=!1,e.body.supportsDataBreakpoints=!1,e.body.supportsReadMemoryRequest=!1,e.body.supportsDisassembleRequest=!1,e.body.supportsCancelRequest=!1,e.body.supportsBreakpointLocationsRequest=!1,this.sendResponse(e)}disconnectRequest(e,t,i){this.sendResponse(e),this.shutdown()}launchRequest(e,t,i){this.sendResponse(e)}attachRequest(e,t,i){this.sendResponse(e)}terminateRequest(e,t,i){this.sendResponse(e)}restartRequest(e,t,i){this.sendResponse(e)}setBreakPointsRequest(e,t,i){this.sendResponse(e)}setFunctionBreakPointsRequest(e,t,i){this.sendResponse(e)}setExceptionBreakPointsRequest(e,t,i){this.sendResponse(e)}configurationDoneRequest(e,t,i){this.sendResponse(e)}continueRequest(e,t,i){this.sendResponse(e)}nextRequest(e,t,i){this.sendResponse(e)}stepInRequest(e,t,i){this.sendResponse(e)}stepOutRequest(e,t,i){this.sendResponse(e)}stepBackRequest(e,t,i){this.sendResponse(e)}reverseContinueRequest(e,t,i){this.sendResponse(e)}restartFrameRequest(e,t,i){this.sendResponse(e)}gotoRequest(e,t,i){this.sendResponse(e)}pauseRequest(e,t,i){this.sendResponse(e)}sourceRequest(e,t,i){this.sendResponse(e)}threadsRequest(e,t){this.sendResponse(e)}terminateThreadsRequest(e,t,i){this.sendResponse(e)}stackTraceRequest(e,t,i){this.sendResponse(e)}scopesRequest(e,t,i){this.sendResponse(e)}variablesRequest(e,t,i){this.sendResponse(e)}setVariableRequest(e,t,i){this.sendResponse(e)}setExpressionRequest(e,t,i){this.sendResponse(e)}evaluateRequest(e,t,i){this.sendResponse(e)}stepInTargetsRequest(e,t,i){this.sendResponse(e)}gotoTargetsRequest(e,t,i){this.sendResponse(e)}completionsRequest(e,t,i){this.sendResponse(e)}exceptionInfoRequest(e,t,i){this.sendResponse(e)}loadedSourcesRequest(e,t,i){this.sendResponse(e)}dataBreakpointInfoRequest(e,t,i){this.sendResponse(e)}setDataBreakpointsRequest(e,t,i){this.sendResponse(e)}readMemoryRequest(e,t,i){this.sendResponse(e)}disassembleRequest(e,t,i){this.sendResponse(e)}cancelRequest(e,t,i){this.sendResponse(e)}breakpointLocationsRequest(e,t,i){this.sendResponse(e)}customRequest(e,t,i,n){this.sendErrorResponse(t,1014,"unrecognized request",null,f.Telemetry)}convertClientLineToDebugger(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e+1:this._clientLinesStartAt1?e-1:e}convertDebuggerLineToClient(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e-1:this._clientLinesStartAt1?e+1:e}convertClientColumnToDebugger(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e+1:this._clientColumnsStartAt1?e-1:e}convertDebuggerColumnToClient(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e-1:this._clientColumnsStartAt1?e+1:e}convertClientPathToDebugger(e){return this._clientPathsAreURIs!==this._debuggerPathsAreURIs?this._clientPathsAreURIs?E.uri2path(e):E.path2uri(e):e}convertDebuggerPathToClient(e){return this._debuggerPathsAreURIs!==this._clientPathsAreURIs?this._debuggerPathsAreURIs?E.uri2path(e):E.path2uri(e):e}static path2uri(e){"win32"===process.platform&&(/^[A-Z]:/.test(e)&&(e=e[0].toLowerCase()+e.substr(1)),e=e.replace(/\\/g,"/")),e=encodeURI(e);let t=new r.URL("file:");return t.pathname=e,t.toString()}static uri2path(e){let t=new r.URL(e),i=decodeURIComponent(t.pathname);return"win32"===process.platform&&(/^\/[a-zA-Z]:/.test(i)&&(i=i[1].toLowerCase()+i.substr(2)),i=i.replace(/\//g,"\\")),i}static formatPII(e,t,i){return e.replace(E._formatPIIRegexp,(function(e,n){return t&&n.length>0&&"_"!==n[0]?e:i[n]&&i.hasOwnProperty(n)?i[n]:e}))}}E._formatPIIRegexp=/{([^}]+)}/g,t.DebugSession=E},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e){this.seq=0,this.type=e}}t.Message=n;t.Response=class extends n{constructor(e,t){super("response"),this.request_seq=e.seq,this.command=e.command,t?(this.success=!1,this.message=t):this.success=!0}};t.Event=class extends n{constructor(e,t){super("event"),this.event=e,t&&(this.body=t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),s=i(22),o=i(23),r={};t.definitions=r;function a(e){return/\s+/.test(e)}function c(e){return e?e.substring(1):e}function p(e,t){let i=t?"":",";return i+=e.name,i+=":"+e.type,e.optional&&(i="["+i+"]"),i}function l(e,t){r[e]?r[e].push(t):r[e]=[t]}t.MumpsToken=class{constructor(e,t){this.document=e,this.position=t,this.range=e.getWordRangeAtPosition(t),this.range&&(this.word=e.getText(this.range),this.word&&(this.surroundWord=function(e,t){if(t.start.character<=0)return;let i=new n.Position(t.start.line,t.start.character-1),s=new n.Position(t.end.line,t.end.character+1),o=e.getText(new n.Range(i,s));if("$"===o.charAt(0)){i=new n.Position(i.line,i.character-1);let t=e.getText(new n.Range(i,s));"$"===t.charAt(0)&&(o=t)}return o}(e,this.range)||this.word,this.isIntrinsic&&(this.word="$"+this.word)))}get mayBeCommand(){if(!this.surroundWord)return!1;let e=this.surroundWord.charAt(this.surroundWord.length-1);return(a(this.surroundWord.charAt(0))||"."===this.surroundWord.charAt(0))&&(":"===e||a(e)||this.surroundWord.length===this.word.length+1)}get isIntrinsic(){return!!this.surroundWord&&("$"===this.surroundWord.charAt(0)&&"$"!==this.surroundWord.charAt(1))}get isFunctionCall(){return!!this.surroundWord&&"("===this.surroundWord.charAt(this.surroundWord.length-1)}get isLabelReference(){if(void 0===this._isLabelReference){let e=this.document.lineAt(this.range.start),t=this.isIntrinsic?this.word.substring(1):this.word,i=new RegExp("(([ \t](D|DO|G|GOTO)[ \t]+)|\\$\\$)([%\\^\\+A-Z0-9]*"+t+"[%\\^\\+A-Z0-9]*)","i").exec(e.text);if(this._isLabelReference=null!==i,i){let e=i[4],t=/([%A-Z][%A-Z0-9]*)?(\+\d+)?(\^[%A-Z][%A-Z0-9]*)?/gi.exec(e);t&&(this.label=t[1],this.labelOffset=Number(c(t[2])),this.labelProgram=c(t[3])),this.referredToLabel=s.lookupLabelReference(this)}}return this._isLabelReference}get definition(){if(void 0===this._definition){this._definition=!1;let e=r[this.word.toUpperCase()];if(e){for(let t of e)if(!this.isFunctionCall||"function"===t.type){this._definition=t;break}}else this.isLabelReference&&(this._definition=s.createDefinitionForLabelReference(this.referredToLabel));this._definition&&"function"===this._definition.type&&(this._definition.functionSignature=function(e){let t=e.name+"(";if(e.parameters)for(let i=0;i<e.parameters.length;i++)t+=p(e.parameters[i],0===i);t+=")",e.returns&&(t+=":"+e.returns.type);return t}(this._definition))}return this._definition}};for(let e of o)l(e.name,e),e.abbreviation&&l(e.abbreviation,e)},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("net")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(r,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i(1),o=i(2),r=i(17),a=i(3);var c;!function(e){e[e.Verbose=0]="Verbose",e[e.Log=1]="Log",e[e.Warn=2]="Warn",e[e.Error=3]="Error",e[e.Stop=4]="Stop"}(c=t.LogLevel||(t.LogLevel={}));class p{constructor(){this._pendingLogQ=[]}log(e,t=c.Log){e+="\n",this._write(e,t)}verbose(e){this.log(e,c.Verbose)}warn(e){this.log(e,c.Warn)}error(e){this.log(e,c.Error)}dispose(){if(this._currentLogger){const e=this._currentLogger.dispose();return this._currentLogger=null,e}return Promise.resolve()}_write(e,t=c.Log){e+="",this._pendingLogQ?this._pendingLogQ.push({msg:e,level:t}):this._currentLogger&&this._currentLogger.log(e,t)}setup(e,t,i=!0){const n="string"==typeof t?t:t&&this._logFilePathFromInit;if(this._currentLogger){const t={consoleMinLogLevel:e,logFilePath:n,prependTimestamp:i};this._currentLogger.setup(t).then(()=>{if(this._pendingLogQ){const e=this._pendingLogQ;this._pendingLogQ=null,e.forEach(e=>this._write(e.msg,e.level))}})}}init(e,t,i){this._pendingLogQ=this._pendingLogQ||[],this._currentLogger=new l(e,i),this._logFilePathFromInit=t}}t.Logger=p,t.logger=new p;class l{constructor(e,t){this.beforeExitCallback=()=>this.dispose(),this._logCallback=e,this._logToConsole=t,this._minLogLevel=c.Warn,this.disposeCallback=(e,t)=>{this.dispose(),t=t||2,t+=128,process.exit(t)}}setup(e){return n(this,void 0,void 0,(function*(){if(this._minLogLevel=e.consoleMinLogLevel,this._prependTimestamp=e.prependTimestamp,e.logFilePath)if(o.isAbsolute(e.logFilePath)){const i=t=>this.sendLog(`Error creating log file at path: ${e.logFilePath}. Error: ${t.toString()}\n`,c.Error);try{yield(t=o.dirname(e.logFilePath),new Promise((e,i)=>{r(t,t=>{t?i(t):e()})})),this.log("Verbose logs are written to:\n",c.Warn),this.log(e.logFilePath+"\n",c.Warn),this._logFileStream=s.createWriteStream(e.logFilePath),this.logDateTime(),this.setupShutdownListeners(),this._logFileStream.on("error",e=>{i(e)})}catch(e){i(e)}}else this.log("logFilePath must be an absolute path: "+e.logFilePath,c.Error);var t}))}logDateTime(){let e=new Date;const t=e.getUTCFullYear()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCDate()+", "+m();this.log(t+"\n",c.Verbose,!1)}setupShutdownListeners(){process.addListener("beforeExit",this.beforeExitCallback),process.addListener("SIGTERM",this.disposeCallback),process.addListener("SIGINT",this.disposeCallback)}removeShutdownListeners(){process.removeListener("beforeExit",this.beforeExitCallback),process.removeListener("SIGTERM",this.disposeCallback),process.removeListener("SIGINT",this.disposeCallback)}dispose(){return new Promise(e=>{this.removeShutdownListeners(),this._logFileStream?(this._logFileStream.end(e),this._logFileStream=null):e()})}log(e,t,i=!0){if(this._minLogLevel!==c.Stop){if(t>=this._minLogLevel&&this.sendLog(e,t),this._logToConsole){const i=t===c.Error?console.error:t===c.Warn?console.warn:null;i&&i(h(e))}t===c.Error&&(e=`[${c[t]}] ${e}`),this._prependTimestamp&&i&&(e="["+m()+"] "+e),this._logFileStream&&this._logFileStream.write(e)}}sendLog(e,t){if(e.length>1500){const t=!!e.match(/(\n|\r\n)$/);e=e.substr(0,1500)+"[...]",t&&(e+="\n")}if(this._logCallback){const i=new u(e,t);this._logCallback(i)}}}class u extends a.OutputEvent{constructor(e,t){super(e,t===c.Error?"stderr":t===c.Warn?"console":"stdout")}}function h(e){return e.replace(/(\n|\r\n)$/,"")}function m(){let e=new Date;return d(2,String(e.getUTCHours()))+":"+d(2,String(e.getUTCMinutes()))+":"+d(2,String(e.getUTCSeconds()))+"."+d(3,String(e.getUTCMilliseconds()))+" UTC"}function d(e,t){return t.length>=e?t:String("0".repeat(e)+t).slice(-e)}t.LogOutputEvent=u,t.trimLastNewline=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);function s(e){return 0!==e.length&&" "!==e.charAt(0)&&"\t"!==e.charAt(0)&&";"!==e.charAt(0)}function o(e){let t="";t+="\t;****************\n",t+="\t; DESCRIPTION: \n";let i=e.match(/\(.*\)/);return null!==i&&i.length>0&&(i=i[0].substring(1,i[0].length-1).split(","),i.length>0&&(t+="\t; PARAMETERS: \n",i.forEach((function(e){t+="\t;    "+e+"(I/O,REQ): \n"})))),t+="\t; RETURNS: \n",t+="\t; REVISIONS: \n",t+="\t;****************\n",t}t.DocumentFunction=function(){let e=n.window.activeTextEditor;if(e){let t=e.document,i=e.selection.start.with(e.selection.start.line,0);for(;i.line<t.lineCount;){if(""!==e.document.lineAt(i.line).text.replace(/\t|\ /i,""))break;i=i.translate(1,0)}for(i.line===t.lineCount&&(i=i.translate(-1,0));i.line>=0;){let t=e.document.lineAt(i.line).text;if(s(t)){e.edit(e=>{e.insert(i,o(t))});break}i=i.translate(-1,0)}}},t.getSigInfo=function(e,t,i){if(e.text){let n=e.text.match(/DESCRIPTION:.*/i);null!==n&&(t.description=n[0]);for(let t in i){let n=e.text.match(new RegExp(t+"\\(.*\\):.*","i"));null!==n&&(i[t].description=n)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=i(1);var s;!function(e){e.global="global",e.local="local",e.exfunction="exfunction",e.nonMfunction="nonMfunction",e.entryref="entryref",e.operator="operator",e.keyword="keyword",e.ifunction="ifunction",e.label="label",e.comment="comment",e.sysvariable="sysvariable",e.string="string",e.number="number"}(s=t.TokenType||(t.TokenType={}));const o=/^[A-Za-z%][A-Za-z0-9]*(\([A-Za-z%][A-Za-z0-9]*(,[A-Za-z%][A-Za-z0-9]*)*\))?/,r=/^[A-Za-z%][A-Za-z0-9]*/,a=/^\^[A-Za-z%][A-Za-z0-9]*/,c=/^\$(DEVICE|ECODE|EC|ESTACK|ES|ETRAP|ET|HALT|HOROLOG|H|IO|I|JOB|J|KEY|K|NAMESPACE|PRINCIPAL|P|QUIT|Q|REFERENCE|R|STACK|ST|STORAGE|S|SYSTEM|TEST|THIS|TLEVEL|TL|T|USERNAME|X|Y|ZALLOCSTOR|ZA|ZB|ZCHSET|ZCLOSE|ZCMDLINE|ZCM|ZCOMPILE|ZCO|ZCSTATUS|ZC|ZDATEFORM|ZDA|ZDIRECTORY|ZD|ZEDITOR|ZED|ZEOF|ZEO|ZE[A-Z]*|ZGBLDIR|ZG|ZHRORLOG|ZH|ZININTERRUPT|ZINI|ZINTERRUPT|ZINT|ZIO|ZJOB|ZJ|ZKEY|ZLEVEL|ZL|ZMAXTPTIME|ZMAXTPTI|ZMODE|ZMO|ZONLNRLBK|ZPATNUMERIC|ZPATN|ZPIN|ZPOSITION|ZPOS|ZPOUT|ZPROMPT|ZQUIT|ZREALSTOR|ZRELDATE|ZRO[A-Z]*|ZSOURCE|ZSO|ZSTA[A-Z]*|ZSTEP|ZSTRP|ZSTRPLLIM|ZST|ZSYSTEM|ZSY|ZS|ZTEXIT|ZTE|ZTIMEOUT|ZTIM|ZTRAP|ZT|ZUSEDSTOR|ZUT|ZVERSION|ZV[A-Z]*|ZYERROR|ZYRELEASE|ZTDATA|ZTDELIM|ZTLEVEL|ZTNAME|ZTOLDVAL|ZTRIGGEROP|ZTSLATE|ZTUPDATE|ZTVALUE|ZTWORMHOLE)/i,p=/^\$(ASCII|A|CHAR|C|DATA|D|EXTRACT|E|FIND|F|FNUMBER|FN|GET|G|INCREMENT|INCR|I|JUSTIFY|J|LENGTH|L|NAME|NA|NEXT|N|ORDER|O|PIECE|P|QLENGTH|QL|QSUBSCRIPT|QS|QUERY|Q|RANDOM|R|REVERSE|RE|SELECT|S|STACK|ST|TEXT|T|TRANSLATE|TR|VIEW|V|ZAHANDLE|ZAH|ZASCII|ZATRANSFORM|ZAT|ZBITAND|ZBITCOUNT|ZBITFIND|ZBITGET|ZBITLEN|ZBITNOT|ZBITOR|ZBITSET|ZBITSTR|ZBITXOR|ZCHAR|ZCH|ZCOLLATE|ZCONVERT|ZCO|ZDATE|ZDATA|ZD|ZEXTRACT|ZE|ZFIND|ZF|ZGETJPI|ZG|ZINCREMENT|ZINCR|ZJOBEXAM|ZJUSTIFY|ZJ|ZLENGTH|ZL|ZMESSAGE|ZPARSE|ZPEEK|ZPIECE|ZPI|ZPREVIOUS|ZP|ZQGBLMOD|ZSEARCH|ZSIGPROC|ZSOCKET|ZSUBSTR|ZSUB|ZSYSLOG|ZTRANSLATE|ZTRIGGER|ZTRI|ZTRNLNM|ZTR|ZWIDTH|ZWRITE|ZW)(?=\()/i,l=/^\$\&([A-Za-z%0-9][A-Za-z0-9]*.)?([A-Za-z%0-9][A-Za-z0-9]*)?(\^[A-Za-z%][A-Za-z0-9]*)?/,u=/^(\&[A-Za-z0-9]*\.?)?@?([A-Za-z%0-9][A-Za-z0-9]*)?(\^@?[A-Za-z%][A-Za-z0-9]*)?/,h=/^\^@?[A-Za-z%][A-Za-z0-9]*/,m=/^(\d*\.?\d*(E-?\d+)?)/,d=/^"([^"]*("")*)*"/,g=/^[B|BREAK|C|CLOSE|D|DO|E|ELSE|F|FOR|G|GOTO|H|HALT|HANG|I|IF|J|JOB|K|KILL|L|LOCK|M|MERGE|N|NEW|O|OPEN|Q|QUIT|R|READ|S|SET|U|USE|V|VIEW|W|WRITE|X|XECUTE|ZA|ZALLOCATE|ZBR|ZBREAK|ZC|ZCONTINUE|ZD|ZDEALLOCATE|ZE|ZEDIT|ZG|ZGOTO|ZHALT|ZH|ZHELP|ZK|ZKILL|ZL|ZLINK|ZM|ZMESSAGE|ZP|ZPRINT|ZRUPDATE|ZSH|ZSHOW|ZST|ZSTEP|ZSY|ZSYSTEM|ZTC|ZTCOMMIT|ZTR|ZTRIGGER|ZTS|ZTSTART|ZWI|ZWITHDRAW|ZWR|ZWRITE]/i,b=/^('=|'>|'<|<=|>=|'&|'!|'\?|'\[|'\]|\*\*|\+|\-|\*|\/|\\|#|'|&|!|_|<|>|=|\[|\]|\?|@)/,f=/(\-|'|\+|@)/,E=/^([A|C|E|L|N|P|U]|^("([^"]("")*)*"))+/i,v=/^\d*\.?\d*/,T=/^APPEND|ATTACH=|BLOCK(SIZE)?=|COMMAND=|CONNECT=|(NO)?DELIM(ITER)?=?|EXC(EPTION)?=|FIFO|(NO)?FIXED|GROUP=|[IO]?CHSET=|KEY|IKEY|INDEPENDANT|IOERROR=|NEW[A-Z]*|MOREREADTIME=|OKEY|OWNER=|(NO)?RCHK|(NO)?READ(ONLY)?|RECORD(SIZE)?=|(NO)?RETRY|REWIND|SEEK=|SHELL=|STDERR=|(NO)?STREAM|SYSTEM=|(NO)?TRUNCATE|UIC=|VARIABLE|WORLD=|Z?(NO)?WRAP|WRITE(ONLY)?|ZBFSIZE|Z(NO)?DELAY|Z(NO)?FF|ZIBFSIZE|Z?LISTEN=/i,R=/^ATTACH|(NO)?CENABLE|[IO]?CHSET=|CLEAR(SCREEN)?|CONNECT|(NO)?CONVERT|CTRAP=|(NO)?DELIM(ITER)?=?|DETACH|DOWNSCROLL|(NO)?ECHO|(NO)?EDITING|ERASELINE|(NO)?ESC(APE)?|EXC(EPTION)?=|(NO)?FILTER=?|FLUSH|GROUP=|KEY|IKEY|IOERROR=|OKEY|OWNER=|(NO)?PASTHRU|(NO)?RCHK|(NO)?RETRY|REWIND|SEEK=|SKIPFILE=|SOCKET=|SPACE=|TERM(INATOR)?=|(NO)?TRUNCATE|(NO)?TTSNYC|(NO)?TYPEAHEAD|UPSCROLL|Z?LENGTH=|Z?WIDTH=|Z?(NO)?WRAP|WRITELB=|X=|Y=|ZBFSIZE|Z(NO)?DELAY|Z(NO)?FF|ZIBFSIZE|LISTEN=/i,x=/^DELETE|(NO)?DESTROY|EXCEPTION=|GROUP=|OWNER=|RENAME=|SOCKET=|TIMEOUT=|UIC=|WORLD=/i,S=/^CMD=|CMDLINE=|DEF=|DEFAULT=|ERR=|ERROR=|GBL=|GBLDIR=|IN=|INPUT=|OUT=|OUTPUT=|PASS|PASSCURLVN|STA=|STARTUP=/i,y=/^SERIAL|S|T=|TRANSACTIONID=/i,A={B:"BREAK",C:"CLOSE",D:"DO",E:"ELSE",F:"FOR",G:"GOTO",H:"HALT",I:"IF",J:"JOB",K:"KILL",L:"LOCK",M:"MERGE",N:"NEW",O:"OPEN",Q:"QUIT",R:"READ",S:"SET",U:"USE",V:"VIEW",W:"WRITE",X:"XECUTE",ZA:"ZALLOCATE",ZB:"ZBREAK",ZC:"ZCONTINUE",ZD:"ZDEALLOCATE",ZED:"ZEDIT",ZG:"ZGOTO",ZH:"ZHELP",ZK:"ZKILL",ZL:"ZLINK",ZM:"ZMESSAGE",ZP:"ZPRINT",ZSH:"ZSHOW",ZST:"ZSTEP",ZSY:"ZSYSTEM",ZTC:"ZTCOMMIT",ZTR:"ZTRIGGER",ZTS:"ZTSTART",ZWI:"ZWITHDRAW",ZWR:"ZWRITE"},k={A:"ASCII",C:"CHAR",D:"DATA",E:"EXTRACT",F:"FIND",FN:"FNUMBER",G:"GET",I:"INCREMENT",J:"JUSTIFY",L:"LENGTH",NA:"NAME",N:"NEXT",O:"ORDER",P:"PIECE",QL:"QLENGTH",QS:"QSUBSCRIPT",Q:"QUERY",R:"RANDOM",RE:"REVERSE",S:"SELECT",ST:"STACK",T:"TEXT",TR:"TRANSLATE",V:"VIEW",ZA:"ZASCII",ZAH:"ZAHANDLE",ZD:"ZDATE",ZE:"ZEXTRACT",ZF:"ZFIND",ZG:"ZGETJPI",ZJ:"ZJUSTIFY",ZL:"ZLENGTH",ZM:"ZMESSAGE",ZPI:"ZPIECE",ZP:"ZPREVIOUS",ZSUB:"ZSUBSTR",ZTR:"ZTRANSLATE",ZTRI:"ZTRIGGER",ZW:"ZWIDTH"},_={BREAK:{abbreviation:"B",postcondition:!0,parameter:"[expr[:tvexpr][,...]]"},CLOSE:{abbreviation:"C",postcondition:!0,parameter:"expr[:(keyword[=expr][:...])][,...]"},DO:{abbreviation:"D",postcondition:!0,parameter:"[entryref[(expr:.lvn[,...])][:tvexpr][,...]]"},ELSE:{abbreviation:"E",postcondition:!1,parameter:""},FOR:{abbreviation:"F",postcondition:!1,parameter:"[lvn=expr[:numexpr1[:numexpr2]][,...]]]"},GOTO:{abbreviation:"G",postcondition:!0,parameter:"entryref[:tvexpr][,...]"},HALT:{abbreviation:"H",postcondition:!0,parameter:""},HANG:{abbreviation:"H",postcondition:!0,parameter:"numexpr[,...]"},IF:{abbreviation:"I",postcondition:!1,parameter:"[tvexpr[,...]]"},JOB:{abbreviation:"J",postcondition:!0,parameter:"entryref[(expr[,...])][:[(keyword[=value][:...])][:numexpr]][,...]"},KILL:{abbreviation:"K",postcondition:!0,parameter:"[glvn | (lvn[,...]) | *lname | *lvn ]"},LOCK:{abbreviation:"L",postcondition:!0,parameter:"[[-|+]nref|(nref[,...])[:numexpr] [,...]]"},MERGE:{abbreviation:"M",postcondition:!0,parameter:"glvn=glvn[,...]"},NEW:{abbreviation:"N",postcondition:!0,parameter:"[[(]lvn[,...][)][,...]]"},OPEN:{abbreviation:"O",postcondition:!0,parameter:"expr[:[(keyword[=expr][:...])] [:numexpr]][,...]"},QUIT:{abbreviation:"Q",postcondition:!0,parameter:"[expr | *lname | *lvn]"},READ:{abbreviation:"R",postcondition:!0,parameter:"(glvn|*glvn|glvn#intexpr)[:numexpr]|strlit|fcc[,...]"},SET:{abbreviation:"S",postcondition:!0,parameter:"setleft=expr | (setleft[,...])=expr | *lvn=lname | aliascontainer[,...]"},TCOMMIT:{abbreviation:"TC",postcondition:!0,parameter:""},TRESTART:{abbreviation:"TRE",postcondition:!0,parameter:""},TROLLBACK:{abbreviation:"TRO",postcondition:!0,parameter:"[intexpr]"},TSTART:{abbreviation:"TS",postcondition:!0,parameter:"[([lvn...])|lvn|*|][:keyword|(keyword...)]"},USE:{abbreviation:"U",postcondition:!0,parameter:"expr[:(keyword[=expr][:...])][,...]"},VIEW:{abbreviation:"V",postcondition:!0,parameter:"keyword[:expr[:...]][,...]"},WRITE:{abbreviation:"W",postcondition:!0,parameter:"expr|*intexpr|fcc[,...]"},XECUTE:{abbreviation:"X",postcondition:!0,parameter:"expr[:tvexpr][,...]"},ZALLOCATE:{abbreviation:"ZA",postcondition:!0,parameter:"[(]nref[,...][)][:intexpr][,...]"},ZBREAK:{abbreviation:"ZB",postcondition:!0,parameter:"[-]entryref[:[expr][:intexpr]][,...]"},ZCOMPILE:{abbreviation:"ZCOM",postcondition:!0,parameter:"expr[,...]"},ZCONTINUE:{abbreviation:"ZC",postcondition:!0,parameter:""},ZDEALLOCATE:{abbreviation:"ZD",postcondition:!0,parameter:"[nref[,...]]"},ZEDIT:{abbreviation:"ZED",postcondition:!0,parameter:"[expr[,...]]"},ZGOTO:{abbreviation:"ZG",postcondition:!0,parameter:"[[intexpr][:entryref[:tvexpr]],...]"},ZHALT:{abbreviation:"ZHALT",postcondition:!0,parameter:"[intexpr]"},ZHELP:{abbreviation:"ZH",postcondition:!0,parameter:"[expr1[:expr2],...]"},ZKILL:{abbreviation:"ZK",postcondition:!0,parameter:"glvn"},ZLINK:{abbreviation:"ZL",postcondition:!0,parameter:"[expr1[:expr2][,...]]"},ZMESSAGE:{abbreviation:"ZM",postcondition:!0,parameter:"intexpr[:expr2][:...]"},ZPRINT:{abbreviation:"ZP",postcondition:!0,parameter:"[entryref[:label[+intexpr]][,...]"},ZRUPDATE:{abbreviation:"ZRUP",postcondition:!0,parameter:"expr[,...]"},ZSHOW:{abbreviation:"ZSH",postcondition:!0,parameter:"[expr[:glvn][,...]]"},ZSTEP:{abbreviation:"ZST",postcondition:!0,parameter:"[keyword[:expr]][,...]"},ZSYSTEM:{abbreviation:"ZSY",postcondition:!0,parameter:"[expr][,...]]"},ZTCOMMIT:{abbreviation:"ZTC",postcondition:!0,parameter:"[intexpr]"},ZTRIGGER:{abbreviation:"ZTR",postcondition:!0,parameter:"gvn"},ZTSTART:{abbreviation:"ZTS",postcondition:!0,parameter:""},ZWITHDRAW:{abbreviation:"ZWI",postcondition:!0,parameter:"glvn"},ZWRITE:{abbreviation:"ZWR",postcondition:!0,parameter:"[zwrglvn[,...]]"}},L={ASCII:{maxparams:2},CHAR:{maxparams:99},DATA:{maxparams:1,format:"glvn"},EXTRACT:{maxparams:3},FIND:{maxparams:3},FNUMBER:{minparams:2,maxparams:3},GET:{maxparams:2,format:"glvn,expr"},INCREMENT:{maxparams:2,format:"glvn,expr"},JUSTIFY:{maxparams:3},LENGTH:{maxparams:2},NAME:{maxparams:2,format:"glvn,expr"},NEXT:{maxparams:1,format:"glvn("},ORDER:{maxparams:2,format:"glvn,expr"},PIECE:{maxparams:4},QLENGTH:{maxparams:1,format:"glvn"},QSUBSCRIPT:{maxparams:2,format:"glvn,expr"},QUERY:{maxparams:1,format:"glvn"},RANDOM:{maxparams:1},REVERSE:{maxparams:1},SELECT:{maxparams:99,format:"special"},STACK:{maxparams:2},TEXT:{maxparams:1,format:"entryref"},TRANSLATE:{maxparams:3},VIEW:{maxparams:2},ZASCII:{maxparams:2},ZATRANSFORM:{minparams:2,maxparams:4,format:"expr,expr,bool,bool"},ZBITAND:{minparams:2,maxparams:2},ZBITCOUNT:{maxparams:1},ZBITFIND:{maxparams:3},ZBITGET:{minparams:2,maxparams:2},ZBITLEN:{maxparams:1},ZBITNOT:{maxparams:1},ZBITOR:{minparams:2,maxparams:2},ZBITSET:{minparams:3,maxparams:3},ZBITSTR:{maxparams:2},ZBITXOR:{minparams:2,maxparams:2},ZCHAR:{maxparams:99},ZCOLLATE:{maxparams:3,format:"glvn,expr,bool"},ZCONVERT:{maxparams:3},ZDATA:{maxparams:1,format:"lvn"},ZDATE:{maxparams:4},ZEXTRACT:{maxparams:3},ZFIND:{maxparams:3},ZGETJPI:{minparams:2,maxparams:2},ZJOBEXAM:{minparams:0,maxparams:1},ZJUSTIFY:{minparams:2,maxparams:3},ZLENGTH:{maxparams:2},ZMESSAGE:{maxparams:1},ZPARSE:{maxparams:5},ZPEEK:{maxparams:4},ZPIECE:{maxparams:4},ZPREVIOUS:{maxparams:1,format:"glvn"},ZQGBLMOD:{maxparams:1,format:"gvn"},ZSEARCH:{maxparams:2},ZSIGPROC:{maxparams:2},ZSOCKET:{minparams:2,maxparams:4},ZSUBSTR:{minparams:2,maxparams:3},ZSYSLOG:{maxparams:1},ZTRANSLATE:{maxparams:3},ZTRIGGER:{maxparams:2},ZTRNLNM:{maxparams:6},ZWIDTH:{maxparams:1},ZWRITE:{maxparams:2}},C=0,I=1,Z=2,w=3,O=4;t.MumpsLineParser=class{constructor(){this.tokens=[],this.linePosition=0}_evaluatePattern(e,t,i){let n={text:"",position:t},s=!1;void 0===i&&(i=0);do{if("@"===e[t]){n=this.evaluateExpression(C,e,++t),s=!0;break}if(!e.substring(n.position).match(v)){if(")"===e[n.position]){if(!s)throw n.text="Incomplete pattern",n;return n.position++,n}if(","===e[n.position]&&i>0){if(!s)throw n.text="Incomplete pattern",n;n.position++;continue}break}{let t=e.substring(n.position).match(v)[0];if(""===t){if(")"===e[n.position]){if(!s)throw n.text="Incomplete pattern",n;return i>0&&n.position++,n}if(","===e[n.position]&&i>0){n.position++;continue}break}if(s=!1,n.position+=t.length,e.substring(n.position).match(E)){s=!0,n.position+=e.substring(n.position).match(E)[0].length;continue}if("("===e[n.position]){n=this._evaluatePattern(e,++n.position,i+1),s=!0;continue}}}while(t<e.length);if(!s)throw n.text="Incomplete pattern",n;if(i>0)throw n.text='Missing ")"',n;return n}evaluateExpression(e,t,i,n){let o=!1,a=i;void 0===n&&(n=0);let u="";for(;i<t.length;){let h=t.charAt(i);if("("===h){let s=C;switch(u){case"ifunction":s=w;break;case"exfunction":s=Z;break;case"pattern":throw{text:'Unecpected "("',position:i}}let r=this.evaluateExpression(s,t,++i,n+1);if(e===O)return r;o=!0,i=r.position;continue}if(u="",")"===h){if(!o){if(i===a&&e===Z)return{text:"",position:++i};throw{text:"Incomplete Expression",position:i}}return n>0&&i++,{text:"",position:i}}if("."===h&&e===Z){i++;let e=t.substring(i);if(e.match(r)){let n=e.match(r)[0];if(this.tokens.push({type:s.local,name:n,position:i+this.linePosition}),i+=n.length,h=t.charAt(i),","!==h&&")"!==h)throw{text:"Variablereference must stand alone",position:i};o=!0;continue}}if(","===h){if(!o){if(i===a&&e===Z){if(0===n)return{text:"",position:++i};o=!1,a=++i;continue}throw{text:"Incomplete Expression",position:i}}if(e===C||e===O)return{text:"",position:i};o=!1,a=++i;continue}if(o){if(e===O)return{text:"",position:i};if(t.substring(i).match(b)){let e=t.substring(i).match(b)[0];if(this.tokens.push({name:e,position:i+this.linePosition,type:s.operator}),i+=e.length,o=!1,"?"===e||"'?"===e){i=this._evaluatePattern(t,i).position,o=!0,u="pattern"}continue}return{text:"",position:i}}let g=t.substring(i);try{let e=this._checkVar(t,i);o=!0,i=e.position}catch(e){if("$$"===g.substring(0,2))i+=2,o=!0,i=(e=this._checkEntryRef(t,i,!0,!0)).position,o=!0;else if(g.match(l)){let e=g.match(l)[0];this.tokens.push({type:s.nonMfunction,name:e,position:i+this.linePosition}),i+=e.length,u="exfunction",o=!0}else if(g.match(p)){let e=g.match(p)[0].substring(1).toUpperCase();this.tokens.push({name:"$"+e,position:i+this.linePosition,type:s.ifunction}),i+=e.length+2,void 0!==k[e]&&(e=k[e]),i=this._checkFunction(e,t,i).position,u="",o=!0}else if(g.match(c)){let e=g.match(c)[0];this.tokens.push({name:e,position:i+this.linePosition,type:s.sysvariable}),i+=e.length,o=!0}else if(g.match(m)&&""!==g.match(m)[0]){let e=g.match(m)[0];this.tokens.push({name:e,type:s.number,position:i+this.linePosition}),i+=e.length,o=!0}else if(g.match(d)){let e=g.match(d)[0];this.tokens.push({name:e,type:s.string,position:i+this.linePosition}),i+=e.length,o=!0}else{if(!h.match(f))throw{text:"Unexpected Character "+h,position:i};this.tokens.push({name:h,type:s.operator,position:i+this.linePosition}),i++}}}if(o){if(n>0)throw{text:'Missing ")"',position:i};return{text:"",position:i}}throw{text:"Incomplete Expression",position:i}}_extractLabel(e){e.lineLabel="";let t=e.lineExpression;e.lineExpression="",t.match(o)&&(e.lineLabel=t.match(o)[0]);let i=e.lineLabel.length;if(i===t.length)return e;if(!t.charAt(i).match(/[\s|;]/))return e.errorText="Unexpected Character"+t.charAt(i),e.errorPosition=i,e;let n=0;for(n=i;n<=t.length&&(" "===t[n]||"\t"===t[n]);n++);return e.lineLeadSpace=t.substring(i,n),n!==t.length-1&&(e.lineExpression=t.substring(n),e.expressionPosition=n),e}_extractComment(e){let t=e.lineExpression;if(t.search(";")>=0){let i=!1;for(let n=0;n<t.length;n++){if(";"===t[n]&&!i)return e.lineExpression=t.substring(0,n),e.lineComment={comment:t.substring(n).substring(1),position:n+e.expressionPosition},e;'"'===t[n]&&(i=!i)}}return e}_extractIndentation(e){let t=[],i=0,n=e.lineExpression,s="",o=0;for(o=0;o<=n.length;o++){let e=n[o];if("."!==e){if(" "!==e&&"\t"!==e)break;s+=e}else i>0&&t.push(s),i++,s=""}return i>0&&(t.push(s),e.lineExpression=n.substring(o),e.expressionPosition+=o,e.lineIndentationArray=t),e}_extractCommands(e){let t,i=[],n=this._splitCommandsAndArguments(e),s=0;for(t={mCommand:"",mPostCondition:"",mArguments:"",cmdPosition:0,argPosition:0,pcPosition:0};s<n.length;){if(s%2==0)t.mCommand=n[s].command,t.cmdPosition=n[s].position;else{t.mArguments=n[s].command,t.argPosition=n[s].position;let e=s+1;for(;e<n.length&&""===n[e].command;)n.splice(e,1);i.push(t),t={mCommand:"",mPostCondition:"",mArguments:"",cmdPosition:0,argPosition:0,pcPosition:0}}s++}n.length%2!=0&&(t.mCommand=n[n.length-1].command,t.cmdPosition=n[n.length-1].position,t.mArguments="",t.argPosition=e.lineExpression.length,i.push(t));let o=this._extractPostConditional(i);return o.length>0&&(e.lineRoutines=o),e}_splitCommandsAndArguments(e){let t=[],i=0,n=!1,s=e.lineExpression,o=e.expressionPosition;for(let e=0;e<s.length;e++)'"'===s[e]&&(n=!n)," "!==s[e]&&"\t"!==s[e]||n||(s.substring(i,e).length>0?t.push({command:s.substring(i,e),position:o+i}):0!==s.substring(i,e).length||" "!==s.substring(i-1,i)&&"\t"!==s.substring(i-1,i)||t.push({command:s.substring(i,e),position:o+i}),i=e+1);let r=s.length;return s.substring(i,r).length>0?t.push({command:s.substring(i,r),position:o+i}):r!==i||" "!==s.substring(r-1,r)&&"/t"!==s.substring(r-1,r)||t.push({command:"",position:o+i}),t}_extractPostConditional(e){let t=e;for(let e=0;e<t.length;e++){let i=t[e].mCommand.indexOf(":");i>-1&&(t[e].mPostCondition=t[e].mCommand.substring(i+1),t[e].mCommand=t[e].mCommand.substring(0,i),t[e].pcPosition=t[e].cmdPosition+i+1)}return t}parseLine(e){let t={lineExpression:e,expressionPosition:0};return t=this._extractLabel(t),t.errorText||(t=this._extractComment(t),t=this._extractIndentation(t),t=this._extractCommands(t),delete t.lineExpression),t}checkFile(e){let t,i=[];try{t=n.readFileSync(e,"utf8")}catch(t){return i.push({text:"File read error: "+e,position:0,line:0}),i}let s=t.split("\n");for(let e=0;e<s.length;e++){s[e]=s[e].replace("\r","");let t=this.checkLine(s[e]);""!==t.text&&(t.line=e+1,i.push(t))}return i}analyzeLines(e){let t=e.split("\n"),i=[];for(let e=0;e<t.length;e++)t[e]=t[e].replace("\r",""),this.checkLine(t[e]),i[e]=this.tokens;return i}_splitLabelAndParameters(e){if(-1===e.indexOf("("))this.tokens.push({name:e,position:0,type:s.label});else{let t=e.split("("),i=t[0];this.tokens.push({name:i,position:0,type:s.label});let n=t[1].split(")")[0].split(","),o=i.length+1;for(let e=0;e<n.length;e++)this.tokens.push({name:n[e],position:o,type:s.local}),o+=n[e].length+1}}checkLine(e){this.tokens=[],this.linePosition=0;let t=this.parseLine(e);t.lineLabel&&this._splitLabelAndParameters(t.lineLabel),t.lineComment&&this.tokens.push({name:t.lineComment.comment,position:t.lineComment.position,type:s.comment});let i={text:"",position:0};if(t.lineRoutines)for(let e=0;e<t.lineRoutines.length;e++){let n=t.lineRoutines[e];if(n.mCommand.length>0){this.tokens.push({name:n.mCommand,type:s.keyword,position:n.cmdPosition});let e=n.mCommand.toUpperCase();if("H"===e&&(e=""===n.mArguments?"HALT":"HANG"),!e.match(g))return{text:"Invalid Command",position:n.cmdPosition};{let t=e;if(void 0===_[e]&&(t=A[e]),void 0===t)return i.text="Unknown Command",i.position=n.cmdPosition,i;try{i=this._checkCommand(t,n)}catch(i){return i}}}}return i}_checkEntryRefAndPostcondition(e,t,i){let n={text:"",position:t};return n=this._checkEntryRef(e,n.position,i),":"===e[n.position]&&(n=this.evaluateExpression(C,e,++n.position)),n}_checkEntryRef(e,t,i,n){void 0===n&&(n=!1);let o=s.entryref;n&&(o=s.exfunction);let r={text:"",position:t};if("@"===e[r.position]){if(r=this.evaluateExpression(O,e,++r.position),"+"===e[r.position]&&(r=this.evaluateExpression(C,e,++r.position)),"^"===e[r.position])if("@"===e[r.position+1])r=this.evaluateExpression(O,e,++r.position);else{if(!e.substring(r.position).match(u))throw r.text="Invalid EntryRef",r;{let t=e.substring(r.position).match(u)[0];r.position+=t.length}}"@("===e.substring(r.position,r.position+2)&&r.position++}else{if(!e.substring(r.position).match(u))throw r.text="Invalid Entryref",r;{let t=e.substring(r.position).match(u)[0],i=r.position;r.position+=t.length;let n=e[r.position];if(r.position>=e.length){if(t.length>0)return"&"===t[0]&&(o=s.nonMfunction),this.tokens.push({type:o,name:t,position:i+this.linePosition}),r;throw r.text="Missing Entryref",r}if(-1===t.indexOf("^")&&"+"===n){if(r=this.evaluateExpression(C,e,++r.position),r.position>=e.length)return this.tokens.push({type:o,name:t,position:i+this.linePosition}),r;if(e.substring(r.position).match(h)){let i=e.substring(r.position).match(h)[0];t+=i,r.position+=i.length}}this.tokens.push({type:o,name:t,position:i+this.linePosition})}}return"("===e[r.position]&&i&&(r=this.evaluateExpression(Z,e,++r.position,1)),r}_checkVar(e,t,i,n){let o={text:"",position:t,indexFound:!1,globalFound:!1,indirectionFound:!1},c=!1;if(void 0===i&&(i=!0),void 0===n&&(n=!0),"@"===e[o.position])o=this.evaluateExpression(O,e,++o.position),o.indirectionFound=!0,c=!0,"@("===e.substring(o.position,o.position+2)&&o.position++;else if(e.substring(o.position).match(a)||"^|"===e.substring(o.position,o.position+2)){if(!i)throw o.text="Global not allowed here",o;if(o.globalFound=!0,"^|"===e.substring(o.position,o.position+2)){if(o.position+=2,o=this.evaluateExpression(C,e,o.position),o.globalFound=!0,","===e[o.position]&&(o=this.evaluateExpression(C,e,++o.position),o.globalFound=!0),"|"!==e[o.position])throw o.text='Missing "|"',o;if(o.position++,e.substring(o.position).match(r)){let t=e.substring(o.position).match(r)[0];this.tokens.push({name:t,type:s.global,position:o.position+this.linePosition}),c=!0,o.position+=t.length}}else{let t=e.substring(o.position).match(a)[0];this.tokens.push({name:t,type:s.global,position:o.position+this.linePosition}),c=!0,o.position+=t.length}}else if(e.substring(o.position).match(r)){let t=e.substring(o.position).match(r)[0];this.tokens.push({name:t,type:s.local,position:o.position+this.linePosition}),c=!0,o.position+=t.length}else if("^("===e.substring(o.position,o.position+2)){if(o.globalFound=!0,!i)throw o.text="Global not allowed here",c=!1,o;c=!0,o.position++}if(c&&"("===e[o.position]){if(!n)throw o.text="Index not allowed here",o;let t=this.evaluateExpression(I,e,++o.position,1);o.position=t.position,o.indexFound=!0}if(!c)throw o.text="Name missing",o;return o}_checkBreak(e,t){let i=this.evaluateExpression(C,e,t);return":"===e[i.position]&&(i=this.evaluateExpression(C,e,++i.position)),i}_checkKeyword(e,t,i){let n={text:"",position:i};if(!t.substring(n.position).match(e))throw n.text="No valid Keyword for command found",n;{let i=t.substring(n.position).match(e)[0];n.position+=i.length,"="===i.slice(-1)&&(n=this.evaluateExpression(C,t,n.position))}return n}_checkOUC(e,t,i){let n={text:"",position:i};if(n=this.evaluateExpression(C,t,n.position),":"===t[n.position])if(n.position++,"("===t[n.position]){n.position++;let i=!1;do{if(n=this._checkKeyword(e,t,n.position),i=!0,")"===t[n.position]){n.position++;break}if(":"!==t[n.position])throw n.text="Unecpected Character",n;n.position++,i=!1}while(n.position<t.length);if(!i)throw n.text='Missing ")" or Keyword',n}else":"!==t[n.position]&&(n=this._checkKeyword(e,t,n.position));return e===T&&":"===t[n.position]&&(n.position++,":"!==t[n.position]&&(n=this.evaluateExpression(C,t,n.position))),e===T&&":"===t[n.position]&&(n=this.evaluateExpression(C,t,++n.position)),n}_checkFor(e,t,i){let n={text:"",position:t};if(i>1)try{let t=this._checkVar(e,n.position,!1);'"'===e[t.position]&&(n.position=t.position+1)}catch(e){if("Name missing"!==e.text)throw n}else{if(n=this._checkVar(e,n.position,!1),"="!==e[n.position])throw n.text="Missing equal-sign",n;n.position++}return n=this.evaluateExpression(C,e,n.position),":"!==e[n.position]?n:(n=this.evaluateExpression(C,e,++n.position),":"!==e[n.position]||(n=this.evaluateExpression(C,e,++n.position)),n)}_checkJobKeyword(e,t){let i={text:"",position:t};if(!e.substring(i.position).match(S))throw i.text="No valid Keyword for JOB Command",i;{let t=e.substring(i.position).match(S)[0];if(i.position+=t.length,"="===t[t.length-1]){if(!e.substring(i.position).match(d))throw i.text="String literal expected",i;{let t=e.substring(i.position).match(d)[0];if(i.position+=t.length,0===t.length)throw i.text="String literal expected",i}}}return i}_checkJob(e,t){let i=this._checkEntryRef(e,t,!0);if(":"===e[i.position])if(i.position++,"("===e[i.position]){i.position++;let t=!1;do{if(i=this._checkJobKeyword(e,i.position),t=!0,")"===e[i.position]){i.position++;break}if(":"!==e[i.position])throw i.text="Unecpected Character",i;i.position++,t=!1}while(i.position<e.length);if(!t)throw i.text='Missing ")" or Keyword',i}else":"!==e[i.position]&&(i=this._checkJobKeyword(e,i.position));return":"===e[i.position]&&(i=this.evaluateExpression(C,e,++i.position)),i}_checkKill(e,t){let i={text:"",position:t};if("("===e[i.position]){i.position++;let t=!1;do{if(i=this._checkVar(e,i.position),t=!0,")"===e[i.position]){i.position++;break}if(","!==e[i.position])throw i.text="Unecpected Character",i;i.position++,t=!1}while(i.position<e.length);if(!t)throw i.text='Missing ")" or Name',i}else i=this._checkVar(e,i.position);return i}_checkLock(e,t,i){let n={text:"",position:t};if("+"!==e[n.position]&&"-"!==e[n.position]||!i||n.position++,"("===e[n.position]){n.position++;let t=!1;do{if(n=this._checkVar(e,n.position),t=!0,")"===e[n.position]){n.position++;break}if(","!==e[n.position])throw n.text="Unecpected Character",n;n.position++,t=!1}while(n.position<e.length);if(!t)throw n.text='Missing ")" or Name',n}else n=this._checkVar(e,n.position);return":"===e[n.position]&&(n=this.evaluateExpression(C,e,++n.position)),n}_checkMerge(e,t){let i={text:"",position:t};if(i=this._checkVar(e,i.position),"="!==e[i.position])throw i.text="Equal-Sign expected",i;return i=this._checkVar(e,++i.position),i}_checkNew(e,t){let i={text:"",position:t};if("("===e[i.position]){i.position++;let t=!1;do{if(e.substring(i.position).match(c)?i.position+=e.substring(i.position).match(c)[0].length:i=this._checkVar(e,i.position,!1),t=!0,")"===e[i.position]){i.position++;break}if(","!==e[i.position])throw i.text="Unecpected Character",i;i.position++,t=!1}while(i.position<e.length);if(!t)throw i.text='Missing ")" or Name',i}else e.substring(i.position).match(c)?i.position+=e.substring(i.position).match(c)[0].length:i=this._checkVar(e,i.position,!1);return i}_checkRead(e,t){let i,n={text:"",position:t},s=!1;"*"===e[n.position]&&(n.position++,s=!0);try{let t=this._checkVar(e,n.position);return n.position=t.position,"#"===e[n.position]&&(n=this.evaluateExpression(C,e,++n.position),""!==n.text)?n:(":"===e[n.position]&&(n=this.evaluateExpression(C,e,++n.position)),n)}catch(t){if(s)throw n.text="Variable expected",n;if(i=e.substring(n.position).match(d))return n.position+=i[0].length,n;if((i=e.substring(n.position).match(/^(#|!)+/))&&(n.position+=i[0].length),"?"===e[n.position])return n=this.evaluateExpression(C,e,++n.position),n}return n}_checkSet(e,t){let i,n={text:"",position:t},s=!1;if("*"===e[n.position]){if(n=this._checkVar(e,++n.position,!1),"="!==e[n.position])throw n.text="Equal-Sign expected",n;return n=this._checkVar(e,++n.position,!1),n}"("===e[n.position]&&(s=!0,n.position++);do{if("@"===e[n.position])try{let t=this._checkVar(e,n.position);if(n.position=t.position,n.position===e.length||","===e[n.position])return n}catch(t){if(n=this.evaluateExpression(O,e,++n.position),n.position===e.length||","===e[n.position])return n}else if(i=e.substring(n.position).match(/^\$Z?(PIECE|P|EXTRACT|E)\(/i)){let t=i[0].substring(1,i[0].length-1).toUpperCase();n.position+=t.length+2,void 0!==k[t]&&(t=k[t]),n=this._checkFunction(t,e,n.position)}else(i=e.substring(n.position).match(c))?n.position+=i[0].length:n=this._checkVar(e,n.position,!0);","===e[n.position]&&s?n.position++:")"===e[n.position]&&s&&(s=!1,n.position++)}while(n.position<e.length&&s);if("="!==e[n.position])throw n.text="Equal-Sign expected",n;return n=this.evaluateExpression(C,e,++n.position),n}_checkTstart(e,t){let i={text:"",position:t};if("("===e[i.position]){if(i.position++,")"!==e[i.position]){let t=!1;do{if(t=!0,i=this._checkVar(e,i.position,!1,!1),")"===e[i.position]){i.position++;break}if(","!==e[i.position])throw i.text="Unecpected Character",i;i.position++,t=!1}while(i.position<e.length);if(!t)throw i.text='Missing ")" or Name',i}}else"*"!==e[i.position]&&(i=this._checkVar(e,i.position,!1,!1));if(":"===e[i.position])if(i.position++,"("===e[i.position]){i.position++;let t=!1;do{if(i=this._checkKeyword(y,e,i.position),t=!0,")"===e[i.position]){i.position++;break}if(":"!==e[i.position])throw i.text="Unecpected Character",i;i.position++,t=!1}while(i.position<e.length);if(!t)throw i.text='Missing ")" or Keyword',i}else i=this._checkKeyword(y,e,i.position);return i}_checkView(e,t){let i={text:"",position:t};for(i=this.evaluateExpression(C,e,i.position);":"===e[i.position];)i=this.evaluateExpression(C,e,++i.position);return i}_checkWrite(e,t){let i,n={text:"",position:t};return"*"===e[n.position]?(n=this.evaluateExpression(C,e,++n.position),n):e.substring(n.position).match(/^\/(EOF|PASS|ACCEPT|LISTEN|L|TLS|WAIT|W)/i)?(n=this._checkWriteSocket(e,n.position),n):(i=e.substring(n.position).match(/^(#|!)+/))?(n.position+=i[0].length,"?"===e[n.position]&&(n=this.evaluateExpression(C,e,++n.position)),n):"?"===e[n.position]?(n=this.evaluateExpression(C,e,++n.position),n):(n=this.evaluateExpression(C,e,n.position),n)}_checkWriteSocket(e,t){let i,n={text:"",position:t};if(i=e.substring(n.position).match(/^\/(EOF|PASS|ACCEPT|LISTEN|L|TLS|WAIT|W)/i)){n.position+=i[0].length;let t=i[0].toUpperCase();if("/EOF"===t)return n;if("("!==e[n.position]){if(!t.match(/^\/(LISTEN|L|WAIT|W)/))throw n.text=t+" needs Parameter(s)",n;return n}n.position++;let s=99;"/LISTEN"===t||"/L"===t||"/WAIT"===t||"/W"===t?s=1:"/TLS"===t&&(s=4);let o=0,r=!1;do{if(o++,o>s)throw n.text="More Parameters than expected",n;if("/ACCEPT"===t&&1===o){if("."!==e[n.position])throw n.text="Local Variablereference expected (.lvn)",n;n=this._checkVar(e,++n.position,!1,!1)}else n=this.evaluateExpression(C,e,n.position);if(r=!0,","!==e[n.position]){if(")"===e[n.position]){n.position++;break}}else r=!1}while(n.position<e.length);if(!r)throw n.text='Missing Parameter or ")"',n}return n}_checkXecute(e,t){let i={text:"",position:t};return i=this.evaluateExpression(C,e,i.position),":"===e[i.position]&&(i=this.evaluateExpression(C,e,++i.position)),i}_checkZbreak(e,t){let i={text:"",position:t};return"-"===e[i.position]&&(i.position++,"*"===e[i.position])?(i.position++,i):(i=this._checkEntryRef(e,i.position,!1),":"===e[i.position]&&(i.position++,":"===e[i.position]?i=this.evaluateExpression(C,e,++i.position):(i=this.evaluateExpression(C,e,++i.position),":"===e[i.position]&&(i=this.evaluateExpression(C,e,++i.position)))),i)}_checkZprint(e,t){let i={text:"",position:t};return i=this._checkEntryRef(e,i.position,!1),":"===e[i.position]&&(i=this._checkEntryRef(e,++i.position,!1)),i}_checkZstep(e,t){let i,n={text:"",position:t};if(!(i=e.substring(n.position).match(/^(INTO|OUTOF|OU|OVER|OV)/i)))throw n.text="Invalid ZSTEP Qualifier",n;return n.position+=i.length,":"===e[n.position]&&(n=this.evaluateExpression(C,e,++n.position)),n}_checkCommand(e,t){let i=_[e],n=i.postcondition,s=i.parameter,o=t.mArguments,r=t.argPosition,a={text:"",position:0};if(!n&&""!==t.mPostCondition)throw{text:"Poscondition not allowed",position:t.pcPosition};if(""!==t.mPostCondition)try{this.linePosition=t.pcPosition,a=this.evaluateExpression(C,t.mPostCondition,0)}catch(a){throw a.position+=t.pcPosition,a}if(""===o){if(""===s||"["===s[0])return{text:"",position:t.argPosition};throw{text:"Argument for command "+t.mCommand+" required",position:t.argPosition}}this.linePosition=r,a.position=0;let c=0;try{do{switch(c++,e){case"BREAK":a=this._checkBreak(o,a.position);break;case"CLOSE":a=this._checkOUC(x,o,a.position);break;case"DO":a=this._checkEntryRefAndPostcondition(o,a.position,!0);break;case"ELSE":if(""!==o)return{text:"No Argument expected",position:t.argPosition};break;case"FOR":a=this._checkFor(o,a.position,c);break;case"GOTO":a=this._checkEntryRefAndPostcondition(o,a.position,!1);break;case"HANG":case"IF":a=this.evaluateExpression(C,o,a.position);break;case"JOB":a=this._checkJob(o,a.position);break;case"KILL":a=this._checkKill(o,a.position);break;case"LOCK":a=this._checkLock(o,a.position,!0);break;case"MERGE":a=this._checkMerge(o,a.position);break;case"NEW":a=this._checkNew(o,a.position);break;case"OPEN":a=this._checkOUC(T,o,a.position);break;case"QUIT":if(c>1)throw a.text="Quit allows only one Argument",a;a="*"===o[a.position]?this._checkVar(o,++a.position,!1):this.evaluateExpression(C,o,a.position);break;case"READ":a=this._checkRead(o,a.position);break;case"SET":a=this._checkSet(o,a.position);break;case"TROLLBACK":c>1?a.text="TROLLBACK allows only one Argument":a=this.evaluateExpression(C,o,a.position);break;case"TSTART":a=this._checkTstart(o,a.position);break;case"USE":a=this._checkOUC(R,o,a.position);break;case"VIEW":a=this._checkView(o,a.position);break;case"WRITE":a=this._checkWrite(o,a.position);break;case"XECUTE":a=this._checkXecute(o,a.position);break;case"ZALLOCATE":a=this._checkLock(o,a.position,!1);break;case"ZBREAK":a=this._checkZbreak(o,a.position);break;case"ZCOMPILE":a=this.evaluateExpression(C,o,a.position);break;case"ZDEALLOCATE":a=this._checkVar(o,a.position);break;case"ZEDIT":a=this.evaluateExpression(C,o,a.position);break;case"ZGOTO":a=this.evaluateExpression(C,o,a.position),":"===o[a.position]&&(a=this._checkEntryRefAndPostcondition(o,++a.position,!1));break;case"ZHALT":a=this.evaluateExpression(C,o,a.position);break;case"ZHELP":a=this.evaluateExpression(C,o,a.position),":"===o[a.position]&&(a=this.evaluateExpression(C,o,++a.position));break;case"ZKILL":a=this._checkVar(o,a.position);break;case"ZLINK":a=this.evaluateExpression(C,o,a.position),":"===o[a.position]&&(a=this.evaluateExpression(C,o,++a.position));break;case"ZMESSAGE":for(a=this.evaluateExpression(C,o,a.position);":"===o[a.position];)a=this.evaluateExpression(C,o,++a.position);break;case"ZPRINT":a=this._checkZprint(o,a.position);break;case"ZRUPDATE":a=this.evaluateExpression(C,o,a.position);break;case"ZSHOW":a=this.evaluateExpression(C,o,a.position),":"===o[a.position]&&(a=this._checkVar(o,++a.position));break;case"ZSTEP":a=this._checkZstep(o,a.position);break;case"ZSYSTEM":case"ZTCOMMIT":a=this.evaluateExpression(C,o,a.position);break;case"ZTRIGGER":if(a=this._checkVar(o,a.position,!0,!1),!a.globalFound)throw a.text="Global Variable expected",a;break;case"ZWITHDRAW":a=this._checkVar(o,a.position);break;case"ZWRITE":a.position+=o.length;break;default:a.position=o.length}if(","!==o[a.position]){if(void 0!==o[a.position])throw a.text='Unexpected Character "'+o[a.position]+'"',a}else if(a.position++,a.position===o.length&&""!==s&&"["!==s[0])throw{text:"Argument for command "+t.mCommand+" required",position:a.position}}while(a.position<o.length)}catch(a){throw a.position+=r,a}return a.position+=t.argPosition,a}_checkFunction(e,t,i){let n={text:"",position:i},s=L[e],o=void 0!==s.minparams?s.minparams:1,r=void 0!==s.format?s.format.split(","):void 0,a=0;if(e="$"+e,0===o&&")"===t[n.position])return n.position++,n;do{let i=void 0!==r&&void 0!==r[a]?r[a]:"expr";if("$SELECT"===e&&(i="special"),"glvn"===i||"gvn"===i||"glvn("===i||"lvn"===i){if(n=this._checkVar(t,n.position),"glvn("===i&&!n.indexFound&&!n.indirectionFound)throw n.text="Variable with Index expected for "+e,n;if("lvn"===i&&n.globalFound)throw n.text="Local variable expected",n}else if("entryref"===i)n=this._checkEntryRef(t,n.position,!1);else if("expr"===i)n=this.evaluateExpression(C,t,n.position);else if("bool"===i){if("0"!==t[n.position]&&"1"!==t[n.position])throw n.text="0/1 expected",n;n.position++}else if("special"===i&&"$SELECT"===e){if(n=this.evaluateExpression(C,t,n.position),":"!==t[n.position])throw n.text="Missing Expression",n;n.position++,n=this.evaluateExpression(C,t,n.position)}a++;let c=t[n.position];if(","!==c){if(")"===c){if(a<o)throw n.text="Less Arguments for "+e+" than expected",n;n.position++;break}throw n.text="Unxepected character ",n}if(a>s.maxparams)throw n.text="More Arguments for "+e+" than expected",n;n.position++}while(n.position<t.length);return n}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(r,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i(0),o=i(12),r=i(21),a=i(24),c=i(25),p=i(9),l=i(26),u=i(29),h=i(30),m=i(10),d=i(34),g=new m.MumpsLineParser,b=i(1);let f;t.activate=function(e){return n(this,void 0,void 0,(function*(){const t={language:"mumps",scheme:"file"},i=s.languages.createDiagnosticCollection("mumps");e.subscriptions.push(s.commands.registerCommand("mumps.getEntryRef",()=>s.window.showInputBox({placeHolder:"Please enter the Entry-Reference to start Debugging",value:""})));let n=e.storagePath;b.existsSync(n)||b.mkdirSync(n);const o=n+"/labeldb.json";e.subscriptions.push(i,s.commands.registerCommand("mumps.documentFunction",()=>{p.DocumentFunction()}),s.commands.registerCommand("mumps.autoSpaceEnter",()=>{h.autoSpaceEnter()}),s.commands.registerCommand("mumps.autoSpaceTab",()=>{h.autoSpaceTab()}),s.languages.registerHoverProvider(t,new r.MumpsHoverProvider),s.languages.registerDefinitionProvider(t,new a.MumpsDefinitionProvider),s.languages.registerSignatureHelpProvider(t,new c.MumpsSignatureHelpProvider,"(",","),s.languages.registerDocumentSymbolProvider(t,new l.MumpsDocumentSymbolProvider),s.languages.registerCompletionItemProvider(t,new u.CompletionItemProvider(o)),s.languages.registerDocumentSemanticTokensProvider(t,d.MumpsHighlighter,d.SemanticTokens),s.languages.registerDocumentFormattingEditProvider(t,{provideDocumentFormattingEdits:(e,t,i)=>{let n=[];for(let t=0;t<e.lineCount;t++){T(e.lineAt(t).text,t,n)}return n}}),s.languages.registerDocumentRangeFormattingEditProvider(t,{provideDocumentRangeFormattingEdits:(e,t,i,n)=>{let s=[];for(let i=t.start.line;i<=t.end.line;i++){T(e.lineAt(i).text,i,s)}return s}}),s.debug.registerDebugConfigurationProvider("mumps",new E),s.debug.registerDebugAdapterDescriptorFactory("mumps",new v),s.window.onDidChangeActiveTextEditor(e=>{e&&R(e.document,i)}),s.workspace.onDidChangeTextDocument(e=>{e&&R(e.document,i)})),s.languages.registerEvaluatableExpressionProvider(t,{provideEvaluatableExpression(e,t){const n=i.get(e.uri);if(n){if(n.find(e=>e.range.contains(t)))return}const o=e.lineAt(t.line).text;let r=/([ (,+\-\*_:=])(\^?%?[a-zA-Z][a-zA-Z\d]*(\(.[^\)]+\))?)/g;")"!==o.substring(t.character,t.character+1)&&(r=/([ (,+\-\*_:=])(\^?%?[a-zA-Z][a-zA-Z\d]*)/g);let a=null;for(;a=r.exec(o);){let e=a.index;e+=a[0].length-a[2].length;let i=e+a[2].length-1;if(e<=t.character&&i>=t.character)return new s.EvaluatableExpression(new s.Range(t.line,e,t.line,i),a[2])}}})}))},t.deactivate=function(){};class E{resolveDebugConfiguration(e,t,i){if(!t.type&&!t.request&&!t.name){const e=s.window.activeTextEditor;e&&"mumps"===e.document.languageId&&(t.type="mumps",t.name="Launch",t.request="launch",t.program="${file}",t.stopOnEntry=!0,t.hostname="127.0.0.1",t.localRoutinesPath="y:\\",t.port=9e3)}return t.program?t:s.window.showInformationMessage("Cannot find a program to debug").then(e=>{})}}class v{createDebugAdapterDescriptor(e){return new s.DebugAdapterInlineImplementation(new o.MumpsDebugSession)}}function T(e,t,i){if(0===e.replace(/(\ |\t)/gi,"").length&&i.push(s.TextEdit.insert(new s.Position(t,0),"\t;")),e.endsWith(". ")?i.push(s.TextEdit.insert(new s.Position(t,e.length),";")):e.endsWith(".")&&i.push(s.TextEdit.insert(new s.Position(t,e.length)," ;")),e.startsWith(" ")){let n;for(n=0;n<e.length&&" "===e.charAt(n);n++);i.push(s.TextEdit.replace(new s.Range(new s.Position(t,0),new s.Position(t,n)),"\t"))}}function R(e,t){f&&(clearTimeout(f),f=void 0),f=setTimeout(()=>function(e,t){if(e){t.clear();let i=[];for(let t=0;t<e.lineCount;t++){let n=e.lineAt(t),o=g.checkLine(n.text);""!==o.text&&i.push({code:"",message:o.text,range:new s.Range(new s.Position(t,o.position),new s.Position(t,n.text.length)),severity:s.DiagnosticSeverity.Error,source:""})}i&&t.set(e.uri,i)}}(e,t),500)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(r,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i(13),o=i(2),{Subject:r}=i(19),a=i(20),c=i(0),p=i(1),l=c.languages.createDiagnosticCollection("mumps");class u extends s.LoggingDebugSession{constructor(){super(),this._variableHandles=new s.Handles,this._configurationDone=new r,this.setDebuggerLinesStartAt1(!1),this.setDebuggerColumnsStartAt1(!1),this._program="",this._mconnect=new a.MConnect,this._mconnect.on("stopOnEntry",()=>{this.sendEvent(new s.StoppedEvent("entry",u.THREAD_ID))}),this._mconnect.on("stopOnStep",()=>{this.sendEvent(new s.StoppedEvent("step",u.THREAD_ID))}),this._mconnect.on("stopOnBreakpoint",()=>{this.sendEvent(new s.StoppedEvent("breakpoint",u.THREAD_ID))}),this._mconnect.on("stopOnDataBreakpoint",()=>{this.sendEvent(new s.StoppedEvent("data breakpoint",u.THREAD_ID))}),this._mconnect.on("stopOnException",e=>{this.sendEvent(new s.StoppedEvent("exception",u.THREAD_ID,e))}),this._mconnect.on("breakpointValidated",e=>{this.sendEvent(new s.BreakpointEvent("changed",{verified:e.verified,id:e.id}))}),this._mconnect.on("output",(e,t,i,n)=>{const o=new s.OutputEvent(e+"\n");o.body.source=this.createSource(t),o.body.line=this.convertDebuggerLineToClient(i),o.body.column=this.convertDebuggerColumnToClient(n),this.sendEvent(o)}),this._mconnect.on("end",()=>{this.sendEvent(new s.TerminatedEvent)})}initializeRequest(e,t){e.body=e.body||{},e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!0,e.body.supportsDataBreakpoints=!1,e.body.supportsCompletionsRequest=!1,e.body.completionTriggerCharacters=[".","["],e.body.supportsCancelRequest=!1,e.body.supportsBreakpointLocationsRequest=!0,e.body.supportsExceptionInfoRequest=!0,e.body.supportsRestartRequest=!0,this.sendResponse(e),this.sendEvent(new s.InitializedEvent)}configurationDoneRequest(e,t){super.configurationDoneRequest(e,t),this._configurationDone.notify()}launchRequest(e,t){return n(this,void 0,void 0,(function*(){s.logger.setup(t.trace?s.Logger.LogLevel.Verbose:s.Logger.LogLevel.Stop,!1),yield this._configurationDone.wait(1e3),this._mconnect.init(t.hostname,t.port,t.localRoutinesPath).then(()=>n(this,void 0,void 0,(function*(){this.refreshDiagnostics(c.window.activeTextEditor.document,l),this._mconnect.start(t.program,!!t.stopOnEntry),this._program=t.program,this.sendResponse(e)}))).catch(e=>{c.window.showErrorMessage("Connection to MDEBUG failed. \nPlease start MDEBUG first.")})}))}setBreakPointsRequest(e,t){const i=t.source.path,n=t.lines||[];this._mconnect.clearBreakpoints(i);const o=n.map(e=>{let{verified:t,line:n,id:o}=this._mconnect.setBreakPoint(i,this.convertClientLineToDebugger(e));const r=new s.Breakpoint(t,this.convertDebuggerLineToClient(n));return r.id=o,r});e.body={breakpoints:o},this.sendResponse(e),this._mconnect.requestBreakpoints()}threadsRequest(e){e.body={threads:[new s.Thread(u.THREAD_ID,"thread 1")]},this.sendResponse(e)}stackTraceRequest(e,t){const i="number"==typeof t.startFrame?t.startFrame:0,n=i+("number"==typeof t.levels?t.levels:1e3),o=this._mconnect.stack(i,n);e.body={stackFrames:o.frames.map(e=>new s.StackFrame(e.index,e.name,this.createSource(e.file),this.convertDebuggerLineToClient(e.line))),totalFrames:o.count},this.sendResponse(e)}scopesRequest(e,t){e.body={scopes:[new s.Scope("Local",this._variableHandles.create("local|0"),!0),new s.Scope("System",this._variableHandles.create("system"),!1)]},this.sendResponse(e)}variablesRequest(e,t,i){return n(this,void 0,void 0,(function*(){const i=[];let n;const s=this._variableHandles.get(t.variablesReference);if("system"===s){let e=this._mconnect.getVariables("system");for(let t in e)i.push({name:t,type:"string",value:e[t],variablesReference:0})}else{const e=s.split("|"),t=parseInt(e.pop()),o=e.join("|");let r,a=this._mconnect.getVariables("local"),c=!0,p="";for(let e in a){let s=this.varAnalyze(e,a[e]);c?(r=s,c=!1):((n=this.checkVars(r,s,t,o,p))&&(0!==n.variablesReference&&(p=r.bases[t]),i.push(n)),r=s)}if(!c){const e={name:"",indexCount:0,bases:[],content:""};(n=this.checkVars(r,e,t,o,p))&&i.push(n)}}e.body={variables:i},this.sendResponse(e)}))}checkVars(e,t,i,n,s){let o=void 0,r=0;if(0===i||e.bases[i-1]===n&&e.indexCount>i)if(e.indexCount>i+1){if(s!==e.bases[i]){let t=e.bases[i];i>0&&(t+=")"),o={name:t,type:"string",value:"undefined",variablesReference:this._variableHandles.create(e.bases[i]+"|"+(i+1))}}}else e.bases[i]===t.bases[i]&&(r=this._variableHandles.create(e.bases[i]+"|"+(i+1))),o={name:e.name,type:"string",value:e.content,variablesReference:r};return o}continueRequest(e,t){this._mconnect.continue(),this.sendResponse(e)}nextRequest(e,t){this._mconnect.step("OVER"),this.sendResponse(e)}stepInRequest(e,t,i){this._mconnect.step("INTO"),this.sendResponse(e)}stepOutRequest(e,t,i){this._mconnect.step("OUTOF")}evaluateRequest(e,t){return n(this,void 0,void 0,(function*(){"hover"!==t.context&&"repl"!==t.context||this._mconnect.getSingleVar(t.expression).then(t=>{e.body={result:t.name+" := "+t.content,variablesReference:0},this.sendResponse(e)})}))}restartRequest(e){return n(this,void 0,void 0,(function*(){let e=p.readFileSync(this._program).toString().split("\n");this._mconnect.checkRoutine(e).then(e=>{e.length?c.window.showErrorMessage("File contains Problems - No Restart possible!"):this._mconnect.restart(this._program)})}))}disconnectRequest(e,t,i){this._mconnect.disconnect(),this.sendResponse(e)}createSource(e){return new s.Source(o.basename(e),this.convertDebuggerPathToClient(e),void 0,void 0,"mock-adapter-data")}varAnalyze(e,t){let i=1,n=[],s=e.length,o=e.indexOf("("),r=!0;if(o>0){n.push(e.substring(0,o)),i++;for(let t=o;t<s;t++)","===e.substring(t,t+1)&&r&&(n.push(e.substring(0,t)),i++),'"'===e.substring(t,t+1)&&(r=!r);n.push(e.substring(0,e.length-1))}else n.push(e);return{name:e,indexCount:i,bases:n,content:t}}refreshDiagnostics(e,t){let i=[];if(e){let n=[];for(let t=0;t<e.lineCount;t++){const i=e.lineAt(t);n.push(i.text)}this._mconnect.checkRoutine(n).then(n=>{for(let t=0;t<n.length;t++){let s=n[t].split(";"),o=parseInt(s[0])-1;isNaN(o)&&(o=0);let r=parseInt(s[1])-1;isNaN(r)&&(r=0);let a=e.lineAt(r).text.length;0===r&&0===o&&(a=0);let p=s[2],l=new c.Range(r,o,r,a),u=new c.Diagnostic(l,p,c.DiagnosticSeverity.Error);u.code=p,i.push(u)}t.clear(),t.set(e.uri,i)})}}}u.THREAD_ID=1,t.MumpsDebugSession=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3);t.DebugSession=n.DebugSession,t.InitializedEvent=n.InitializedEvent,t.TerminatedEvent=n.TerminatedEvent,t.StoppedEvent=n.StoppedEvent,t.ContinuedEvent=n.ContinuedEvent,t.OutputEvent=n.OutputEvent,t.ThreadEvent=n.ThreadEvent,t.BreakpointEvent=n.BreakpointEvent,t.ModuleEvent=n.ModuleEvent,t.LoadedSourceEvent=n.LoadedSourceEvent,t.CapabilitiesEvent=n.CapabilitiesEvent,t.Thread=n.Thread,t.StackFrame=n.StackFrame,t.Scope=n.Scope,t.Variable=n.Variable,t.Breakpoint=n.Breakpoint,t.Source=n.Source,t.Module=n.Module,t.CompletionItem=n.CompletionItem,t.ErrorDestination=n.ErrorDestination;const s=i(16);t.LoggingDebugSession=s.LoggingDebugSession;const o=i(8);t.Logger=o;const r=i(4);t.Event=r.Event,t.Response=r.Response;const a=i(18);t.Handles=a.Handles;const c=o.logger;t.logger=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(6),s=i(4);class o{get event(){return this._event||(this._event=(e,t)=>{let i;return this._listener=e,this._this=t,i={dispose:()=>{this._listener=void 0,this._this=void 0}},i}),this._event}fire(e){if(this._listener)try{this._listener.call(this._this,e)}catch(e){}}hasListener(){return!!this._listener}dispose(){this._listener=void 0,this._this=void 0}}class r extends n.EventEmitter{constructor(){super(),this._sendMessage=new o,this._pendingRequests=new Map,this.onDidSendMessage=this._sendMessage.event}dispose(){}handleMessage(e){if("request"===e.type)this.dispatchRequest(e);else if("response"===e.type){const t=e,i=this._pendingRequests.get(t.request_seq);i&&(this._pendingRequests.delete(t.request_seq),i(t))}}_isRunningInline(){return this._sendMessage&&this._sendMessage.hasListener()}start(e,t){this._sequence=1,this._writableStream=t,this._rawData=new Buffer(0),e.on("data",e=>this._handleData(e)),e.on("close",()=>{this._emitEvent(new s.Event("close"))}),e.on("error",e=>{this._emitEvent(new s.Event("error","inStream error: "+(e&&e.message)))}),t.on("error",e=>{this._emitEvent(new s.Event("error","outStream error: "+(e&&e.message)))}),e.resume()}stop(){this._writableStream&&this._writableStream.end()}sendEvent(e){this._send("event",e)}sendResponse(e){e.seq>0?console.error("attempt to send more than one response for command "+e.command):this._send("response",e)}sendRequest(e,t,i,n){const o={command:e};if(t&&Object.keys(t).length>0&&(o.arguments=t),this._writableStream){if(this._send("request",o),n){this._pendingRequests.set(o.seq,n);const e=setTimeout(()=>{clearTimeout(e);const t=this._pendingRequests.get(o.seq);t&&(this._pendingRequests.delete(o.seq),t(new s.Response(o,"timeout")))},i)}}else this._emitEvent(new s.Event("error","sendRequest: No writableStream"))}dispatchRequest(e){}_emitEvent(e){this.emit(e.event,e)}_send(e,t){if(t.type=e,t.seq=this._sequence++,this._writableStream){const e=JSON.stringify(t);this._writableStream.write(`Content-Length: ${Buffer.byteLength(e,"utf8")}\r\n\r\n${e}`,"utf8")}this._sendMessage.fire(t)}_handleData(e){for(this._rawData=Buffer.concat([this._rawData,e]);;){if(this._contentLength>=0){if(this._rawData.length>=this._contentLength){const e=this._rawData.toString("utf8",0,this._contentLength);if(this._rawData=this._rawData.slice(this._contentLength),this._contentLength=-1,e.length>0)try{let t=JSON.parse(e);this.handleMessage(t)}catch(e){this._emitEvent(new s.Event("error","Error handling data: "+(e&&e.message)))}continue}}else{const e=this._rawData.indexOf(r.TWO_CRLF);if(-1!==e){const t=this._rawData.toString("utf8",0,e).split("\r\n");for(let e=0;e<t.length;e++){const i=t[e].split(/: +/);"Content-Length"==i[0]&&(this._contentLength=+i[1])}this._rawData=this._rawData.slice(e+r.TWO_CRLF.length);continue}}break}}}r.TWO_CRLF="\r\n\r\n",t.ProtocolServer=r},function(e,t){e.exports=require("url")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(8),s=n.logger,o=i(3);class r extends o.DebugSession{constructor(e,t,i){super(t,i),this.obsolete_logFilePath=e,this.on("error",e=>{s.error(e.body)})}start(e,t){super.start(e,t),s.init(e=>this.sendEvent(e),this.obsolete_logFilePath,this._isServer)}sendEvent(e){if(!(e instanceof n.LogOutputEvent)){let t=e;e instanceof o.OutputEvent&&e.body&&e.body.data&&e.body.data.doNotLogOutput&&(delete e.body.data.doNotLogOutput,t=Object.assign({},e),t.body=Object.assign({},e.body,{output:"<output not logged>"})),s.verbose("To client: "+JSON.stringify(t))}super.sendEvent(e)}sendRequest(e,t,i,n){s.verbose(`To client: ${JSON.stringify(e)}(${JSON.stringify(t)}), timeout: ${i}`),super.sendRequest(e,t,i,n)}sendResponse(e){s.verbose("To client: "+JSON.stringify(e)),super.sendResponse(e)}dispatchRequest(e){s.verbose(`From client: ${e.command}(${JSON.stringify(e.arguments)})`),super.dispatchRequest(e)}}t.LoggingDebugSession=r},function(e,t,i){var n=i(2),s=i(1),o=parseInt("0777",8);function r(e,t,i,a){"function"==typeof t?(i=t,t={}):t&&"object"==typeof t||(t={mode:t});var c=t.mode,p=t.fs||s;void 0===c&&(c=o&~process.umask()),a||(a=null);var l=i||function(){};e=n.resolve(e),p.mkdir(e,c,(function(i){if(!i)return l(null,a=a||e);switch(i.code){case"ENOENT":r(n.dirname(e),t,(function(i,n){i?l(i,n):r(e,t,l,n)}));break;default:p.stat(e,(function(e,t){e||!t.isDirectory()?l(i,a):l(null,a)}))}}))}e.exports=r.mkdirp=r.mkdirP=r,r.sync=function e(t,i,r){i&&"object"==typeof i||(i={mode:i});var a=i.mode,c=i.fs||s;void 0===a&&(a=o&~process.umask()),r||(r=null),t=n.resolve(t);try{c.mkdirSync(t,a),r=r||t}catch(s){switch(s.code){case"ENOENT":r=e(n.dirname(t),i,r),e(t,i,r);break;default:var p;try{p=c.statSync(t)}catch(e){throw s}if(!p.isDirectory())throw s}}return r}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Handles=class{constructor(e){this.START_HANDLE=1e3,this._handleMap=new Map,this._nextHandle="number"==typeof e?e:this.START_HANDLE}reset(){this._nextHandle=this.START_HANDLE,this._handleMap=new Map}create(e){var t=this._nextHandle++;return this._handleMap.set(t,e),t}get(e,t){return this._handleMap.get(e)||t}}},function(e,t){function i(){this.waiters=[]}i.prototype.wait=function(e){var t=this,i={};this.waiters.push(i);var n=new Promise((function(e){var n=!1;i.resolve=function(s){if(!n){if(n=!0,i.timeout&&(clearTimeout(i.timeout),i.timeout=null),!s){var o=t.waiters.indexOf(i);o>-1&&t.waiters.splice(o,1)}e()}}}));return e>0&&isFinite(e)&&(i.timeout=setTimeout((function(){i.timeout=null,i.resolve()}),e)),n},i.prototype.notify=function(){this.waiters.length>0&&this.waiters.pop().resolve(!0)},i.prototype.notifyAll=function(){for(var e=this.waiters.length-1;e>=0;e--)this.waiters[e].resolve(!0);this.waiters=[]},t.Subject=i},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(r,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7),o=i(6),r=i(1);class a extends o.EventEmitter{constructor(){super(),this._event=new o.EventEmitter,this._currentLine=0,this._breakpointId=1,this._logging=!1,this._singleVar="",this._singleVarContent="",this._commandQueue=[],this._socket=new s.Socket,this._connectState="waitingforStart",this._readedData="",this._mVars={},this._mStack=[],this._activeBreakpoints=[],this._breakPoints=[],this._errorLines=[],this._singleVar="",this._singleVarContent="",this._hints=[],this._event.on("varsComplete",()=>{if(void 0!==this._mVars.I){let e=this._mVars.I;this.checkEvents(e.$ZPOSITION,e.$ZSTATUS)}})}init(e,t,i){return n(this,void 0,void 0,(function*(){return this._localRoutinesPath=i,this._hostname=e,this._port=t,new Promise((e,t)=>{this._socket.connect(this._port,this._hostname,()=>{this._log("Debug-Server connected\n"),this._socket.on("data",e=>{this._readedData+=e.toString();let t=this._readedData.indexOf("\n");for(;-1!==t;)this.processLine(this._readedData.substring(0,t)),this._readedData=this._readedData.substring(t+1),t=this._readedData.indexOf("\n")}),e(this._socket)}),this._socket.on("error",e=>{t(e)})})}))}_log(e){this._logging&&console.log(e)}processLine(e){let t,i,n;switch(this._connectState){case"waitingforStart":if("***STARTVAR"===e){this._connectState="waitingforVars",this._mStack=[],this._mVars={};break}if("***STARTBP"===e){this._connectState="waitingforBreakpoints",this._activeBreakpoints=[],this._log(e);break}if("***SINGLEVAR"===e){this._connectState="waitingForSingleVar",this._singleVar="",this._singleVarContent="";break}if("***ENDPROGRAM"===e){this.sendEvent("end"),this._socket.end();break}if("***BEGINERRCHK"===e){this._connectState="waitingForErrorreport",this._errorLines=[];break}if("***STARTHINTS"===e){this._connectState="waitingForHints",this._hints=[];break}break;case"waitingforVars":if("***ENDVAR"===e)this._connectState="waitingforStart",this._event.emit("varsComplete");else{for(n=e.substring(0,1),"S"===n&&this._mStack.push(e.substring(2)),t=e.substring(2,e.indexOf("="));(t.split('"').length-1)%2!=0;)t=e.substring(0,e.indexOf("=",t.length+1));i=e.substring(t.length+3).replace(/^"/,"").replace(/"$/,""),void 0===this._mVars[n]&&(this._mVars[n]={}),this._mVars[n][t]=i}break;case"waitingforBreakpoints":"***ENDBP"===e?(this._log(e),this._connectState="waitingforStart",this.verifyBreakpoints()):(this._log(e),this._activeBreakpoints.push(e));break;case"waitingForSingleVar":"***SINGLEEND"===e?(this._connectState="waitingforStart",this._event.emit("SingleVarReceived",this._event,this._singleVar,this._singleVarContent)):"***SINGLEVARCONTENT"===e?this._connectState="waitingForSingleVarContent":this._singleVar+=e;break;case"waitingForSingleVarContent":"***SINGLEEND"===e?(this._connectState="waitingforStart",this._event.emit("SingleVarReceived",this._event,this._singleVar,this._singleVarContent)):this._singleVarContent+=e;break;case"waitingForErrorreport":"***ENDERRCHK"===e?(this._connectState="waitingforStart",this._event.emit("ErrorreportReceived",this._event,this._errorLines)):this._errorLines.push(e);break;case"waitingForHints":"***ENDHINTS"===e?(this._connectState="waitingforStart",this._event.emit("HintsReceived",this._event,this._hints)):this._hints.push(e);default:console.error("Unexpected Message: "+e)}}writeln(e){if(this._commandQueue.push(e),this._commandQueue.length>1e3)throw console.error("Too many Commands in Queue Check Debugger Connection"),new Error;if(this._socket&&this._socket.writable)for(;this._commandQueue.length;)e=this._commandQueue.shift(),this._log(e),this._socket.write(e+"\n")}sendBreakpoint(e,t,i){i?this.writeln("SETBP;"+e+";"+t):this.writeln("CLEARBP;"+e+";"+t)}start(e,t){t&&(e.indexOf("^")?this.sendBreakpoint(e,0,!0):this.sendBreakpoint(e,1,!0)),this.requestBreakpoints(),this.writeln("START;"+e)}step(e){this.writeln(e)}continue(){this.writeln("CONTINUE")}disconnect(){this.writeln("RESET"),this._socket.end()}requestBreakpoints(){this.writeln("REQUESTBP")}restart(e){this.writeln("RESTART;"+e)}checkEvents(e,t){const i=e.split("^"),n=i[0],s=i[1],o=this._localRoutinesPath+s+".m";this.loadSource(o);const r=n.split("+")[0];let a=0;void 0!==n.split("+")[1]&&(a=parseInt(n.split("+")[1]));let c=0;if(""!==r)for(let e=0;e<this._sourceLines.length;e++)if(this._sourceLines[e].substring(0,r.length)===r){c=e;break}if(this._currentLine=c+a,""!==t)this.sendEvent("stopOnException",t);else{this._breakPoints.filter(e=>e.file===this._sourceFile&&e.line===this._currentLine).length>0?this.sendEvent("stopOnBreakpoint"):this.sendEvent("stopOnStep")}}stack(e,t){const i=new Array;for(let t=e;t<this._mStack.length;t++){const e=this._mStack[t],n=this.convertMumpsPosition(e);n.line++,i.push({index:t,name:`${e}(${t})`,file:n.file,line:n.line})}return{frames:i,count:Math.min(this._mStack.length,t)}}setBreakPoint(e,t){const i={verified:!1,file:e,line:t,id:this._breakpointId++};return this._breakPoints.push(i),this.sendBreakpoint(e,i.line+1,!0),i}clearBreakPoint(e,t){let i=this._breakPoints;if(i){const n=i.findIndex(i=>i.file===e&&i.line===t);if(n>=0){const t=i[n];return this.sendBreakpoint(e,t.line,!1),i.splice(n,1),t}}}clearBreakpoints(e){this.writeln("CLEARBP;"+e)}verifyBreakpoints(){let e=[];this._breakPoints.forEach(t=>{t.verified=!1;for(let i=0;i<this._activeBreakpoints.length;i++){let n=this.convertMumpsPosition(this._activeBreakpoints[i]);if(n.file===t.file&&t.line===n.line){t.verified=!0,this.sendEvent("breakpointValidated",t),e[i]=!0;break}}t.verified||this.sendEvent("breakpointValidated",t)});for(let t=0;t<this._activeBreakpoints.length;t++)if(!e[t]){let e=this.convertMumpsPosition(this._activeBreakpoints[t]),i={verified:!0,file:e.file,line:e.line,id:this._breakpointId++};this.sendEvent("breakpointValidated",i)}}getVariables(e){return"system"===e?this._mVars.I:"local"===e?this._mVars.V:void 0}requestHints(e){return n(this,void 0,void 0,(function*(){return new Promise((t,i)=>{this._event.on("HintsReceived",(function e(i,n){i.removeListener("HintsReceived",e),t(n)})),this.writeln("GETHINTS;"+e)})}))}checkRoutine(e){return n(this,void 0,void 0,(function*(){return new Promise((t,i)=>{this._event.on("ErrorreportReceived",(function e(i,n){i.removeListener("ErrorreportReceived",e),t(n)})),this.writeln("ERRCHK");for(let t=0;t<e.length;t++)this.writeln(e[t]);this.writeln("***ENDPROGRAM")})}))}getSingleVar(e){return n(this,void 0,void 0,(function*(){return new Promise((t,i)=>{let n={name:e,indexCount:0,content:"undefined",bases:[]};"$"===e.substring(0,1)?(n.content=void 0!==this._mVars.I?this._mVars.I[e]:"undefined",t(n)):void 0!==this._mVars.V?void 0!==this._mVars.V[e]?(n.content=this._mVars.V[e],t(n)):(this._event.on("SingleVarReceived",(function e(i,s,o){i.removeListener("SingleVarReceived",e),n.name=s,n.content=o,t(n)})),this.writeln("GETVAR;"+e)):t(n)})}))}loadSource(e){e=e.replace("%","_"),this._sourceFile!==e&&(this._sourceFile=e,this._sourceLines=r.readFileSync(this._sourceFile).toString().split("\n"))}convertMumpsPosition(e){let t=e.split("^"),i=t[0],n=t[1].split(" ",1)[0],s=(this._localRoutinesPath+n+".m").replace("%","_"),o=r.readFileSync(s).toString().split("\n"),a=i.split("+")[0],c=0;void 0!==i.split("+")[1]&&(c=parseInt(i.split("+")[1]));let p=0;if(""!==a)for(let e=0;e<o.length;e++)if(o[e].substring(0,a.length)===a){p=e;break}return{file:s,line:p+c-1}}sendEvent(e,...t){this.emit(e,...t)}}t.MConnect=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=i(0).Hover,s=i(5).MumpsToken;t.MumpsHoverProvider=class{provideHover(e,t){let i=new s(e,t);if(i.range&&(i.mayBeCommand||i.isIntrinsic||i.isLabelReference)&&i.definition){let e=i.definition,t={language:"typescript",value:e.functionSignature||e.name};return new n([t,e.description])}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=i(1),s=i(2);const o=i(0),r=i(9);let a=o.Position,c=o.Uri;const p=[".M",".INT",".ZWR",".m",".int",".zwr"];let l={};t.lookupLabelReference=function(e){let t=e.labelProgram?function e(t,i){let o=s.resolve(t.uri.fsPath,"../"+i);if(!n.existsSync(o)){if("%"===i.charAt(0))return e(t,"_"+i.substring(1));for(let e of p){let t=o+e;if(n.existsSync(t)){o=t;break}}}return c.file(o)}(e.document,e.labelProgram):e.document.uri,i=function(e,t){let i=e.split("\n"),n="",s=0;for(s=0;s<i.length;s++)if(null!==i[s].match("^"+t)){n+=i[s]+"\n";for(let e=s-1;e>0&&(0===i[e].length||";"===i[e].charAt(1));e--)n+=i[e]+"\n";break}if(n.length>0)return{text:n,line:s}}(function(e,t){if(e===t.uri)return t.getText();if(e.fsPath===l.fsPath)return l.text;try{return l.text=n.readFileSync(e.fsPath,"utf8"),l.fsPath=e.fsPath,l.text}catch(e){return""}}(t,e.document),e.label);return i?i.position=new a(i.line+(e.labelOffset||0),0):i={text:"",position:new a(0,0)},i.uri=t,i},t.createDefinitionForLabelReference=function(e){if(!e.text)return;let t=/^([%A-Z][A-Z0-9]*)(\((,?[%A-Z][A-Z0-9]*)+\))?/i.exec(e.text);if(!t)return;let i="";e.text.indexOf(";")&&(i=e.text.substring(e.text.indexOf(";")+1));let n=[],s={};if(void 0!==t[2]){n=t[2].substring(1,t[2].length-1).split(",");for(let e=0;e<n.length;e++)n[e]={name:n[e],type:"any"},s[n[e].name]=n[e]}let o={name:t[1],type:"function",parameters:n,commentText:i};return r.getSigInfo(e,o,s),o}},function(e){e.exports=JSON.parse('[{"name":"BREAK","type":"command","abbreviation":"B","description":"Suspend execution or exit a block"},{"name":"CLOSE","type":"command","abbreviation":"C","description":"Release an I/O device"},{"name":"DO","type":"command","abbreviation":"D","description":"Execute a program, section of code or block"},{"name":"ELSE","type":"command","abbreviation":"E","description":"Conditional execution based on $test"},{"name":"FOR","type":"command","abbreviation":"F","description":"Iterative execution of a line or block"},{"name":"GOTO","type":"command","abbreviation":"G","description":"Transfer of control to a label or program"},{"name":"HALT","type":"command","abbreviation":"H","description":"Terminate execution"},{"name":"HANG","type":"command","abbreviation":"H","description":"Delay execution for a specified period of time"},{"name":"IF","type":"command","abbreviation":"I","description":"Conditional execution of remainder of line"},{"name":"JOB","type":"command","abbreviation":"J","description":"Start an independent process"},{"name":"LOCK","type":"command","abbreviation":"L","description":"Exclusive access/release named resource"},{"name":"KILL","type":"command","abbreviation":"K","description":"Delete a local or global variable"},{"name":"MERGE","type":"command","abbreviation":"M","description":"Copy arrays"},{"name":"NEW","type":"command","abbreviation":"N","description":"Create new copies of local variables"},{"name":"OPEN","type":"command","abbreviation":"O","description":"Obtain ownership of a device"},{"name":"QUIT","type":"command","abbreviation":"Q","description":"End a for loop or exit a block"},{"name":"READ","type":"command","abbreviation":"R","description":"Read from a device"},{"name":"SET","type":"command","abbreviation":"S","description":"Assign a value to a global or local variable"},{"name":"TCOMMIT","type":"command","abbreviation":"TC","description":"Commit a transaction"},{"name":"TRESTART","type":"command","abbreviation":"TRE","description":"Roll back / restart a transaction"},{"name":"TROLLBACK","type":"command","abbreviation":"TRO","description":"Roll back a transaction"},{"name":"TSTART","type":"command","abbreviation":"TS","description":"Begin a transaction"},{"name":"USE","type":"command","abbreviation":"U","description":"Select which device to read/write"},{"name":"VIEW","type":"command","abbreviation":"V","description":"Implementation defined"},{"name":"WRITE","type":"command","abbreviation":"W","description":"Write to device"},{"name":"XECUTE","type":"command","abbreviation":"X","description":"Dynamically execute strings"},{"name":"ZALLOCATE","type":"command","abbreviation":"ZA","description":"Reserves the specified name"},{"name":"ZBREAK","type":"command","abbreviation":"ZB","description":"Sets or clears a routine breakpoint"},{"name":"ZCOMPILE","type":"command","abbreviation":"ZCOM","description":"Compiles a routine"},{"name":"ZCONTINUE","type":"command","abbreviation":"ZC","description":"Continues excutioen after a break"},{"name":"ZDEALLOCATE","type":"command","abbreviation":"ZD","description":"Release the specified name"},{"name":"ZEDIT","type":"command","abbreviation":"ZE","description":"Invokes editor for routine editing"},{"name":"ZGOTO","type":"command","abbreviation":"ZG","description":"Moves to EntryRef on a given stacklevel"},{"name":"ZHALT","type":"command","abbreviation":"ZHALT","description":"Stops program execution with a return code"},{"name":"ZHELP","type":"command","abbreviation":"ZH","description":"Accessses M help library"},{"name":"ZKILL","type":"command","abbreviation":"ZK","description":"Kills a data value but not the descendants"},{"name":"ZLINK","type":"command","abbreviation":"ZL","description":"Compiles an links a routine to the current process"},{"name":"ZMESSAGE","type":"command","abbreviation":"ZM","description":"Raises an exception specified by given code"},{"name":"ZPRINT","type":"command","abbreviation":"ZP","description":"Displays source code lines"},{"name":"ZRUPDATE","type":"command","abbreviation":"ZRUPDATE","description":"Publishes the new versions of routines to subscribers"},{"name":"ZSHOW","type":"command","abbreviation":"ZSH","description":"Displays information about the current environment"},{"name":"ZSTEP","type":"command","abbreviation":"ZST","description":"Controls routine execution"},{"name":"ZSYSTEM","type":"command","abbreviation":"ZSY","description":"Creates a child of the current process"},{"name":"ZTCOMMIT","type":"command","abbreviation":"ZTC","description":"Marks the end of a logical transaction"},{"name":"ZTRIGGER","type":"command","abbreviation":"ZTR","description":"Invokes specified Global Triggers"},{"name":"ZTSTART","type":"command","abbreviation":"ZTS","description":"Marks the beginning of a logical transaction"},{"name":"ZWITHDRAW","type":"command","abbreviation":"ZWI","description":"Kills a data value but not the descendants"},{"name":"ZWRITE","type":"command","abbreviation":"ZWR","description":"Displays a complete global or local variable"},{"name":"$DEVICE","type":"variable","abbreviation":"$D","description":"Status of the current device"},{"name":"$ECODE","type":"variable","abbreviation":"$EC","description":"List of unresolved error codes"},{"name":"$ESTACK","type":"variable","abbreviation":"$ES","description":"Number of stack levels; NEWing $ESTACK resets it to 0"},{"name":"$ETRAP","type":"variable","abbreviation":"$ET","description":"Code to execute on error"},{"name":"$HOROLOG","type":"variable","abbreviation":"$H","description":"Days,seconds time stamp"},{"name":"$IO","type":"variable","abbreviation":"$I","description":"Current IO unit"},{"name":"$JOB","type":"variable","abbreviation":"$J","description":"Current process ID"},{"name":"$KEY","type":"variable","abbreviation":"$K","description":"String that terminated the most recent READ command"},{"name":"$PRINCIPAL","type":"variable","abbreviation":"$P","description":"Principal I/O device"},{"name":"$QUIT","type":"variable","abbreviation":"$Q","description":"Whether the current block of code was called as an extrinsic function (e.g. via $$)"},{"name":"$STACK","type":"variable","abbreviation":"$ST","description":"Current process stack level"},{"name":"$STORAGE","type":"variable","abbreviation":"$S","description":"Amount of memory available, in bytes"},{"name":"$SYSTEM","type":"variable","abbreviation":"$SY","description":"System ID"},{"name":"$TEST","type":"variable","abbreviation":"$T","description":"Result of prior IF command or READ/OPEN/LOCK command if invoked with a timeout"},{"name":"$TLEVEL","type":"variable","abbreviation":"$TL","description":"Number transactions in process"},{"name":"$TRESTART","type":"variable","abbreviation":"$TR","description":"Number of restarts on current transaction"},{"name":"$X","type":"variable","abbreviation":"$X","description":"Position of horizontal cursor in current I/O device"},{"name":"$Y","type":"variable","abbreviation":"$Y","description":"Position of vertical cursor in current I/O device"},{"name":"$ASCII","type":"function","abbreviation":"$A","description":"ASCII numeric code of a character","parameters":[{"name":"VALUE","type":"string","description":"A string to get a code from"},{"name":"POS","type":"number","optional":true,"description":"The 1-based position of the character in VALUE; defaults to 1"}],"returns":{"type":"number"}},{"name":"$CHAR","type":"function","abbreviation":"$C","description":"ASCII character from numeric code","parameters":[{"name":"CODE","type":"number","description":"Numeric code to convert to a character"},{"name":"...","type":"number","optional":true,"description":"Additional codes to convert to characters"}],"returns":{"type":"string"}},{"name":"$DATA","type":"function","abbreviation":"$D","description":"Returns data about a variable: 0: if undefined, 1: if valued but has no descendants, 10: if has descendants but no value; 11: if has both a value and descendants","parameters":[{"name":"VAR","type":"reference","description":"The variable to get data about, e.g. ^X"}],"returns":{"type":"number"}},{"name":"$EXTRACT","type":"function","abbreviation":"$E","description":"Extract a substring","parameters":[{"name":"VALUE","type":"string","description":"The string to get a substring from"},{"name":"START","type":"number","optional":true,"description":"The 1-based start index; defaults to 1"},{"name":"END","type":"number","optional":true,"description":"The 1-based end index; defaults to 2"}],"returns":{"type":"string"}},{"name":"$FIND","type":"function","abbreviation":"$F","description":"Find the 1-based index after the end of a substring or 0 if not found","parameters":[{"name":"WITHIN","type":"string","description":"The string to search in"},{"name":"SUBSTRING","type":"string","description":"The substring to search for"},{"name":"START","type":"number","optional":true,"description":"The 1-based index to start searching from; defaults to 1"}],"returns":{"type":"number"}},{"name":"$FNUMBER","type":"function","abbreviation":"$FN","description":"Format a number","parameters":[{"name":"NUMBER","type":"number","description":"The number to format"},{"name":"FORMAT","type":"string","description":"One or more of the following: +: forces \\"+\\" on positive numbers; -: omits the \\"-\\" on negative numbers; ,: comma-separates the number by thousands; T: puts the sign in the trailing position; P: wraps negative numbers in parentheses and wraps positive numbers in spaces and may only be combined with comma (,)"},{"name":"DIGITS","type":"number","optional":true,"description":"The numer of digits after the decimal point"}],"returns":{"type":"any"}},{"name":"$GET","type":"function","abbreviation":"$G","description":"Get default or actual value","parameters":[{"name":"VAR","type":"reference","description":"The variable to query, e.g. ^X(THIS,THAT)"},{"name":"DEFAULT","type":"any","optional":true,"description":"A value to use if VAR has no value; defaults to \\"\\""}],"returns":{"type":"any"}},{"name":"$JUSTIFY","type":"function","abbreviation":"$J","description":"Right-justify a number or string by prefixing with spaces","parameters":[{"name":"VALUE","type":"string","description":"The string to justify"},{"name":"MINLENGTH","type":"number","description":"The minimum length of the result"},{"name":"DIGITS","type":"number","description":"The number of digits after the decimal point; providing this argument makes $JUSTIFY treat VALUE as a number"}],"returns":{"type":"string"}},{"name":"$LENGTH","type":"function","abbreviation":"$L","description":"Determine string length","parameters":[{"name":"VALUE","type":"string","description":"The string"},{"name":"SUBSTRING","type":"string","optional":true,"description":"If present, $LENGTH returns one more than the number of occurences of SUBSTRING in VALUE"}],"returns":{"type":"number"}},{"name":"$NAME","type":"function","abbreviation":"$NA","description":"Evaluate and describe a variable","parameters":[{"name":"VAR","type":"reference","description":"The variable to evaluate, including naked references"},{"name":"MAXSUBSCRIPT","type":"number","optional":true,"description":"The maximum number of subscripts to evaluate if VAR is an array"}],"returns":{"type":"string"}},{"name":"$ORDER","type":"function","abbreviation":"$O","description":"Find the subscript of the next or previous node","parameters":[{"name":"VAR","type":"reference","description":"The array to query, e.g. ^AR"},{"name":"DIRECTION","type":"number","optional":true,"description":"1: forward, -1: reverse; defaults to 1"}],"returns":{"type":"string|number"}},{"name":"$PIECE","type":"function","abbreviation":"$P","description":"Extract substring based on pattern","parameters":[{"name":"VALUE","type":"string","description":"The string"},{"name":"SUBSTRING","type":"string","description":"A delimiting string within VALUE"},{"name":"PIECE","type":"number","optional":true,"description":"Which 1-based piece of the split string to return; defaults to 1"},{"name":"LASTPIECE","type":"number","optional":true,"description":"The 1-based index of the last piece of the split string to return; defaults to PIECE"}],"returns":{"type":"any"}},{"name":"$QLENGTH","type":"function","abbreviation":"$QL","description":"Number of subscripts in an array reference","parameters":[{"name":"VAR","type":"reference","description":"The array to query, e.g. ^AR"}],"returns":{"type":"any"}},{"name":"$QSUBSCRIPT","type":"function","abbreviation":"$QS","description":"Value of specified subscript","parameters":[{"name":"VAR","type":"reference","description":"The array to query, e.g. ^AR"},{"name":"SUBSCRIPT","type":"number","description":"The 1-based index of the subscript to find; special values include -1: environment and 0: unsubscripted name"}],"returns":{"type":"string|number"}},{"name":"$QUERY","type":"function","abbreviation":"$Q","description":"Next item in an array; invoke multiple times to iterate the entire array","parameters":[{"name":"VAR","type":"reference","description":"The array to query, e.g. ^AR"}],"returns":{"type":"any"}},{"name":"$RANDOM","type":"function","abbreviation":"$R","description":"Random number","parameters":[{"name":"LIMIT","type":"number","description":"The generated random number will be between 0 (inclusive) and this LIMIT (exclusive)"}],"returns":{"type":"number"}},{"name":"$REVERSE","type":"function","abbreviation":"$RE","description":"String in reverse order","parameters":[{"name":"VALUE","type":"string","description":"A string to reverse"}],"returns":{"type":"string"}},{"name":"$SELECT","type":"function","abbreviation":"$S","description":"Value of first true argument","parameters":[{"name":"TVEXPR","type":"expression","description":"An expression to test for truth, followed by a colon and a value, e.g. i=42:\\"Answered!\\""},{"name":"...","type":"expression","optional":true,"description":"Additional truth value expressions to test; the last expression often starts with 1: to avoid errors"}],"returns":{"type":"any"}},{"name":"$STACK","type":"function","abbreviation":"$ST","description":"Returns information about the process stack","parameters":[{"name":"LEVEL","type":"number","description":"-1: returns the highest stack level; 0: returns information about how the program was started; 1 to $STACK(-1): returns information about how the stack level was created"},{"name":"FIELD","type":"string","optional":true,"description":"\\"MCODE\\": the line of code that was executed; \\"PLACE\\": location of the executed code; \\"ECODE\\": the error code(s) added at the stack level, if any"}],"returns":{"type":"string|number"}},{"name":"$TEXT","type":"function","abbreviation":"$T","description":"Returns the text of a line of M[UMPS] code","parameters":[{"name":"REFERENCE","type":"string","description":"A reference to a code location, e.g. \'LABEL\' or \'+4^PROGRAM\' or \'LABEL^PROGRAM\', etc."}],"returns":{"type":"string"}},{"name":"$TRANSLATE","type":"function","abbreviation":"$TR","description":"Translate characters in a string","parameters":[{"name":"VALUE","type":"string","description":"The value to translate"},{"name":"OLD","type":"string","description":"Characters in VALUE to replace"},{"name":"NEW","type":"string","optional":true,"description":"Characters to replace OLD characters with; if not provided then OLD characters will be removed"}],"returns":{"type":"string"}},{"name":"$VIEW","type":"function","abbreviation":"$V","description":"Implementation defined"}]')},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=i(0).Location,s=i(5).MumpsToken;t.MumpsDefinitionProvider=class{provideDefinition(e,t){let i=new s(e,t);if(i.isLabelReference&&i.referredToLabel){let e=i.referredToLabel.position;return new n(i.referredToLabel.uri,e)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);let s=n.ParameterInformation,o=n.Position,r=n.SignatureHelp,a=n.SignatureInformation,c=i(5).MumpsToken;t.MumpsSignatureHelpProvider=class{provideSignatureHelp(e,t){let i=e.lineAt(t);if(!i)return;let n=function(e,t,i){let n,s=1;for(n=i.character-1;n>0&&s>0;n--){let e=t.text.charAt(n);")"===e?s++:"("===e&&s--}if(s>0||n<=0)return;return new c(e,new o(i.line,n))}(e,i,t);if(!n||!n.definition)return;let p=function(e){let t=new a(e.functionSignature,e.description);if(e.parameters){t.parameters=[];for(let i of e.parameters){let e=i.optional?"(optional) ":"";e+=i.description||i.name,t.parameters.push(new s(i.name,e))}t.documentation=e.commentText}return t}(n.definition),l=new r;return l.signatures=[p],l.activeSignature=0,l.activeParameter=function(e,t,i){let n=0,s=0;for(let o=t+1;o<i;o++){let t=e.charAt(o);"("===t?s++:")"===t?s--:","===t&&0===s&&n++}return n}(i.text,n.position.character+1,t.character),l}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),s=i(27);t.MumpsDocumentSymbolProvider=class{provideDocumentSymbols(e){return new Promise(t=>{let i=s.parseText(e.getText()),o=[];i.methods.forEach(t=>{let i=n.SymbolKind.Function,s=new n.Position(t.id.position.line,0),r=-1===t.endLine?e.lineCount-1:t.endLine,a=new n.Position(r,0),c=new n.Location(e.uri,new n.Range(s,a));o.push(new n.SymbolInformation(t.id.value,i,"",c))}),t(o)})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(28);var s;!function(e){e[e.method=1]="method",e[e.parameter=2]="parameter",e[e.declaration=4]="declaration",e[e.column=5]="column",e[e.table=6]="table",e[e.proc=7]="proc"}(s=t.MemberClass||(t.MemberClass={}));class o{constructor(){this.parameters=[],this.line=-1,this.declarations=[],this.endLine=-1,this.memberClass=s.method,this.documentation=""}}class r{constructor(){}}t.parseText=function(e){return(new a).parseDocument(e)};class a{constructor(e){this.methods=[],this.declarations=[],this.tokens=[],e&&(this.tokenizer=e)}next(){return this.activeToken=this.tokenizer.next().value,this.activeToken&&this.tokens.push(this.activeToken),void 0!==this.activeToken}parseDocument(e){for(this.tokenizer=n.getTokens(e);this.next();)if(this.activeToken.isAlphanumeric()){let e=this.parseMethod();if(!e)continue;this.methods.push(e),this.activeMethod=e}else if(this.activeToken.isTab()||this.activeToken.isSpace()){let e=this.activeToken.position.line,t=this.loadTokenBuffer();if(this.activeMethod&&this.activeMethod.nextLine===e){let e=this.checkForDocumentation(t);e&&(this.activeMethod.documentation=e)}}else{if(this.activeToken.isNewLine())continue;this.throwAwayTokensTil(13)}return{declarations:this.declarations,methods:this.methods,tokens:this.tokens}}checkForDocumentation(e){let t=0;for(;t<e.length;){let i=e[t];if(!i.isSpace()&&!i.isTab())return i.isLineCommentInit()&&e[t+1]&&e[t+1].isLineComment()?e[t+1].value:"";t++}return""}loadTokenBuffer(){let e=[];for(;this.next()&&13!==this.activeToken.type;)e.push(this.activeToken);return e}parseMethod(){let e=new o;do{if(this.activeToken&&!this.activeToken.isTab()&&!this.activeToken.isSpace()){if(this.activeToken.isNewLine())break;if(this.activeToken.isOpenParen()){let t=this.processParameters(e);if(!t)return;e.parameters=t;break}if(this.activeToken.isAlphanumeric())-1===e.line&&(e.line=this.activeToken.position.line,e.prevLine=this.activeToken.position.line-1,e.nextLine=this.activeToken.position.line+1,e.id=this.activeToken);else{if(this.activeToken.isLineCommentInit()||this.activeToken.isLineComment())continue;if("\r"===this.activeToken.value)continue;if(!this.activeToken.isCloseParen()){if(this.throwAwayTokensTil(13),e.id)break;return}e.closeParen||(e.closeParen=this.activeToken,e.nextLine=this.activeToken.position.line+1)}}}while(this.next());return this.activeMethod&&(this.activeMethod.endLine=e.id.position.line-1),this.activeMethod=e,e}processParameters(e){let t,i=[],n=!1;for(;this.next();)if(!(this.activeToken.isTab()||this.activeToken.isSpace()||this.activeToken.isNewLine()))if(this.activeToken.isOpenParen()){if(n=!0,!t)return}else{if(this.activeToken.isCloseParen()){if(n=!1,e.closeParen=this.activeToken,e.nextLine=this.activeToken.position.line+1,!t)break;i.push(t);break}if(this.activeToken.isAlphanumeric())t||(t=new r),t.id=this.activeToken;else if(this.activeToken.isLineComment())t?t.comment=this.activeToken:i.length>=1&&(i[i.length-1].comment=this.activeToken);else if(this.activeToken.isComma()){if(!t)return;i.push(t),t=void 0}}if(!n)return i}throwAwayTokensTil(e){do{}while(this.next()&&this.activeToken.type!==e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.getTokens=function*(e){let t=new o;for(let i of e){for(t.charType=r(i),0===t.tokenType&&(t.tokenType=t.charType);!t.parsed;)t.parseCharacter(i)&&(yield t.finalizedToken);t.parsed=!1}0!==t.tokenType&&(t.finalizeToken(0),yield t.finalizedToken)};class s{constructor(e,t,i){this.type=e,this.value=t,this.position=i}getRange(){let e=this.position,t=new n.Position(this.position.line,this.position.character+this.value.length);return new n.Range(e,t)}isAlphanumeric(){return 1===this.type}isCloseParen(){return 41===this.type}isComma(){return 44===this.type}isLineComment(){return 3===this.type}isLineCommentInit(){return 6===this.type}isNewLine(){return 13===this.type}isNumeric(){return 2===this.type}isOpenParen(){return 40===this.type}isSpace(){return 32===this.type}isTab(){return 11===this.type}isWhiteSpace(){return 32===this.type||11===this.type||13===this.type||-1===this.type}}t.Token=s;class o{constructor(){this.documentLine=0,this.documentColumn=0,this.charType=0,this.tokenType=0,this.tokenValue="",this.tokenPosition=new n.Position(this.documentLine,this.documentColumn),this.parsed=!1,this.stringOpen=!1,this.firstSlash=!1,this.asterisk=!1}parseCharacter(e){return 1===this.tokenType?1===this.charType||2===this.charType?(this.updateTokenAndAdvanceCursor(e),!1):(this.finalizeToken(this.charType),!0):2===this.tokenType?2===this.charType?(this.updateTokenAndAdvanceCursor(e),!1):(this.finalizeToken(this.charType),!0):3===this.tokenType?13!==this.charType?(this.updateTokenAndAdvanceCursor(e),!1):(this.finalizeToken(13),!0):5===this.tokenType?9!==this.charType?(this.updateTokenAndAdvanceCursor(e),!1):(this.finalizeToken(9),!0):6===this.tokenType?(this.updateTokenAndAdvanceCursor(e),this.finalizeToken(3),!0):59===this.tokenType?(this.tokenType=6,!0):9===this.tokenType?(this.updateTokenAndAdvanceCursor(e),this.stringOpen?(this.stringOpen=!1,this.finalizeToken(0)):(this.stringOpen=!0,this.finalizeToken(5)),!0):13===this.tokenType?(this.tokenValue=this.tokenValue+e,this.parsed=!0,this.documentLine++,this.documentColumn=0,this.finalizeToken(0),!0):(this.tokenType>10||-1===this.tokenType)&&(this.updateTokenAndAdvanceCursor(e),this.finalizeToken(0),!0)}updateTokenAndAdvanceCursor(e){this.tokenValue=this.tokenValue+e,this.parsed=!0,this.documentColumn++}finalizeToken(e){this.finalizedToken=new s(this.tokenType,this.tokenValue,this.tokenPosition),this.tokenType=e,this.tokenValue="",this.tokenPosition=new n.Position(this.documentLine,this.documentColumn)}}function r(e){let t=e.charCodeAt(0);return t>=65&&t<=90||t>=97&&t<=122||37===t?1:t>=48&&t<=57?2:34===t?9:9===t?11:10===t?13:32===t?32:33===t?33:35===t?35:36===t?36:38===t?38:39===t?39:40===t?40:41===t?41:42===t?42:43===t?43:44===t?44:45===t?45:46===t?46:58===t?58:59===t?59:60===t?60:61===t?61:62===t?62:63===t?63:64===t?64:91===t?91:92===t?92:93===t?93:94===t?94:95===t?95:96===t?96:123===t?123:124===t?124:125===t?125:126===t?126:-1}!function(e){e[e.Alphanumeric=1]="Alphanumeric",e[e.Numeric=2]="Numeric",e[e.LineComment=3]="LineComment",e[e.BlockComment=4]="BlockComment",e[e.String=5]="String",e[e.LineCommentInit=6]="LineCommentInit",e[e.DoubleQuotes=9]="DoubleQuotes",e[e.Tab=11]="Tab",e[e.NewLine=13]="NewLine",e[e.Space=32]="Space",e[e.ExclamationMark=33]="ExclamationMark",e[e.NumberSign=35]="NumberSign",e[e.DollarSign=36]="DollarSign",e[e.Ampersand=38]="Ampersand",e[e.SingleQuote=39]="SingleQuote",e[e.OpenParen=40]="OpenParen",e[e.CloseParen=41]="CloseParen",e[e.Asterisk=42]="Asterisk",e[e.PlusSign=43]="PlusSign",e[e.Comma=44]="Comma",e[e.MinusSign=45]="MinusSign",e[e.Period=46]="Period",e[e.Colon=58]="Colon",e[e.SemiColon=59]="SemiColon",e[e.LessThan=60]="LessThan",e[e.EqualSign=61]="EqualSign",e[e.GreaterThan=62]="GreaterThan",e[e.QuestionMark=63]="QuestionMark",e[e.AtSymbol=64]="AtSymbol",e[e.OpenBracket=91]="OpenBracket",e[e.Backslash=92]="Backslash",e[e.CloseBracket=93]="CloseBracket",e[e.Caret=94]="Caret",e[e.Underscore=95]="Underscore",e[e.BackQuote=96]="BackQuote",e[e.OpenBrace=123]="OpenBrace",e[e.Pipe=124]="Pipe",e[e.CloseBrace=125]="CloseBrace",e[e.Tilde=126]="Tilde",e[e.Undefined=-1]="Undefined"}(t.Type||(t.Type={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),s=i(1);t.CompletionItemProvider=class{constructor(e){this._labelsReady=!1,this._dbfile=e,this._refreshLabelDB()}provideCompletionItems(e,t,i){let s=function(e,t){let i="lineStart",n=0,s="",o="",r=!1;if(e)for(;n<t;){let t=e.substring(n,++n),a=" "===t||"\t"===t,c=t.match(/[A-Za-z%^]/),p=t.match(/[A-Za-z]/);if("string"!==i&&";"===t)return{lineStatus:"comment",startstring:""};switch(c||""!==o&&t.match(/[0-9]/)?o+=t:o="",i){case"argument":a?r?(r=!1,s.match(/[D|DO|G|GOTO|J|JOB]/i)&&(i="jumplabel")):(i="command",s=""):'"'===t?i="string":c?i="variable":"$"===t&&(i="function");break;case"command":if(":"===t)i="argument",r=!0;else{if(p){s+=t;break}if(!a)return i="error",{lineStatus:"error",startstring:""};i="argument",s.match(/[D|DO|G|GOTO|J|JOB]/i)&&(i="jumplabel")}break;case"function":a?r?r=!1:(i="command",s=""):"$"===t&&(i="jumplabel"),c||(i="argument");break;case"jumplabel":a?(i="command",s=""):(":"===t||"("===t)&&(i="argument");break;case"label":a?i="command":(t="(")&&(i="variable");break;case"lineStart":i=a?"command":"label";break;case"string":'"'===t&&(i="argument");break;case"variable":a?r?(r=!1,i="argument"):(i="command",s=""):c||(i="argument")}}return{lineStatus:i,startstring:o}}(e.getText(new n.Range(new n.Position(t.line,0),t)),t.character),o=[];if(this._labelsReady&&"jumplabel"===s.lineStatus&&s.startstring.length>1){let e=new n.Range(new n.Position(t.line,t.character-s.startstring.length),t);o=this._findLabel(s.startstring,o,e)}return o}_refreshLabelDB(){if(!s.existsSync(this._dbfile)){let e={labels:[{routine:"",label:""}],routines:{}};s.writeFileSync(this._dbfile,JSON.stringify(e))}s.readFile(this._dbfile,(e,t)=>{if(!e){this._labelDB=JSON.parse(t);let e=!1;n.workspace.findFiles("*.m").then(t=>{this._filesToCheck=t.length;for(let i=0;i<t.length;i++){let n=t[i].fsPath;s.stat(n,!1,(t,i)=>{if(t)this._checkReady(e);else{let t=this._labelDB.routines[n];void 0===t||i.mtimeMs>t?(this._labelDB.routines[n]=i.mtimeMs,e=!0,i.size<5e4?this._refreshFileLabels(n):this._checkReady(e)):this._checkReady(e)}})}this._labelsReady=!0})}})}_checkReady(e){0==--this._filesToCheck&&e&&s.writeFile(this._dbfile,JSON.stringify(this._labelDB),e=>{e&&n.window.showErrorMessage("Error writing Label DB")})}_refreshFileLabels(e){let t=e.replace("\\","/").split("/").pop();t=t.split(".")[0].replace("_","%"),s.readFile(e,"utf8",(e,i)=>{if(!e){let e=i.split("\n"),n="";this._labelDB.labels=this._labelDB.labels.filter(e=>e.routine!==t);for(let i=0;i<e.length;i++)0===i&&this._labelDB.labels.push({label:"*FL",routine:t,line:e[0]}),(n=e[i].match(/^[%A-Za-z0-9][A-Za-z0-9]{0,31}/))&&this._labelDB.labels.push({label:n[0],routine:t,line:e[i]})}this._checkReady(!0)})}_findLabel(e,t,i){let n,s="";if("^"===e.charAt(0)){let t=e.substring(1);n=this._labelDB.labels.filter(e=>e.routine.startsWith(t))}else if(-1!==e.indexOf("^")){let t=e.split("^")[0],i=e.split("^")[1];n=this._labelDB.labels.filter(e=>e.label===t&&e.routine.startsWith(i))}else n=this._labelDB.labels.filter(t=>t.label.startsWith(e));for(let o=0;o<n.length;o++){let r=n[o],a=r.label+"^"+r.routine;if(a===e)continue;if("*FL"===r.label){if(!e.startsWith("^"))continue;a="^"+r.routine,s="100"}let c="";"("===r.line.charAt(r.label.length)&&-1!==r.line.indexOf(")")&&(c=r.line.split(")")[0]+")"),-1!==r.line.indexOf(";")&&(c+=r.line.substring(r.line.indexOf(";")+1)),c.length>0&&"100"!==s&&(s="099"),t.push({label:a,detail:c,sortText:s,range:i})}return t}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(r,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i(0);let o=i(31);t.autoSpaceEnter=function(){return n(this,void 0,void 0,(function*(){let e=s.window.activeTextEditor;if(e){let t=e.selection.active,i=e.document.lineAt(t.line).text,n=o.parse(i),r="";0!==t.character&&((void 0===n[0].lineRoutines||0===n[0].lineRoutines.length)&&-1===i.indexOf(";")&&void 0!==n[0].lineIndentationArray&&n[0].lineIndentationArray.length>0?(n[0].lineIndentationArray.splice(-1),e.edit(e=>{e.replace(new s.Range(t.with(t.line,0),t.with(t.line,i.length)),o.render(n))})):(void 0===n[0].lineIndentationArray&&(n[0].lineIndentationArray=[]),function(e){let t=e.lineRoutines;if(t=e.lineRoutines)for(let e=0;e<t.length;e++)if(t[e].mRoutine.match(/(d|do)/i)&&!t[e].mArguments)return!0;return!1}(n[0])&&n[0].lineIndentationArray.push(" "),n[0].lineRoutines=[],delete n[0].lineComment,delete n[0].lineLabel,r=o.render(n))),e.edit(e=>{e.insert(t,"\n"+r)})}}))},t.autoSpaceTab=function(){return n(this,void 0,void 0,(function*(){let e=s.window.activeTextEditor;if(e){let t=e.selection.active,i=e.document.lineAt(t.line).text,n=o.parse(i);(void 0===n[0].lineRoutines||0===n[0].lineRoutines.length)&&-1===i.indexOf(";")&&void 0!==n[0].lineIndentationArray&&n[0].lineIndentationArray.length>0?(n[0].lineIndentationArray.push(" "),e.edit(e=>{" "===i.charAt(t.character-1)?e.insert(t.with(t.line,t.character),". "):e.insert(t.with(t.line,t.character)," . ")})):e.edit(e=>{e.insert(t,"\t")})}}))}},function(e,t,i){"use strict";var n=i(32),s=i(33);function o(e){var t={};return t=n.extractLabel(e,t),t=n.extractComment(t.lineExpression,t),t=n.extractIndentation(t.lineExpression,t),delete(t=n.extractRoutines(t.lineExpression,t)).lineExpression,t}function r(e){var t="";return t=s.appendLabel(e,t),t=s.appendIndentation(e,t),t=s.appendRoutines(e,t),t=s.appendComment(e,t)}e.exports.parse=function(e){for(var t=(e=e.replace("\r","")).split("\n"),i=[],n=0;n<t.length;n++){var s=o(t[n]);s.lineNumber=n+1,i.push(s)}return i},e.exports.render=function(e){var t="",i=[];Array.isArray(e)?i=e:i.push(e);for(var n=0;n<i.length;n++){var s=r(i[n]);n===i.length-1?t+=s:t=t+s+"\n"}return t}},function(e,t,i){"use strict";function n(e){for(var t=[],i=0,n=0;n<=e.length;n++)" "===e[n]||"\t"===e[n]?e.substring(0,n).split('"').length%2!=0&&e.substring(n).split('"').length%2!=0&&(e.substring(i,n).length>0?t.push(e.substring(i,n)):0!==e.substring(i,n).length||" "!==e.substring(i-1,i)&&"\t"!==e.substring(i-1,i)||t.push(e.substring(i,n)),i=n+1):n===e.length&&(e.substring(i,n).length>0?t.push(e.substring(i,n)):n!==i||" "!==e.substring(n-1,n)&&"/t"!==e.substring(n-1,n)||t.push(""));return t}function s(e){for(var t=e,i=0;i<t.length;i++)if(t[i].mRoutine){var n=t[i].mRoutine.indexOf(":");n>-1&&(t[i].mPostConditional=t[i].mRoutine.substring(n+1),t[i].mRoutine=t[i].mRoutine.substring(0,n))}return t}e.exports.extractLabel=function(e,t){for(var i=0;i<=e.length;i++){if(" "!==e[i]&&"\t"!==e[i]){if(0===i){t.lineLabel=e.split(/[ \t]/,1)[0];for(var n=t.lineLabel.length;n<=e.length;n++){if(" "!==e[n]&&"\t"!==e[n]){t.lineLeadSpace=e.substring(t.lineLabel.length,n),t.lineExpression=e.substring(n);break}if(n===e.length-1){t.lineLeadSpace=e.substring(t.lineLabel.length),t.lineExpression="";break}}break}t.lineLeadSpace=e.substring(0,i),t.lineExpression=e.substring(i);break}if(i===e.length-1){t.lineLeadSpace=e,t.lineExpression="";break}}return t},e.exports.extractComment=function(e,t){if(e.search(";")>=0){for(var i=0;i<e.length;i++)if(";"===e[i]){if(e.substring(0,i).split('"').length%2!=0&&e.substring(i).split('"').length%2!=0){t.lineExpression=e.substring(0,i),t.lineComment=e.substring(i).substring(1);break}if(e.substring(0,i).replace("").split('"').length%2!=0&&e.substring(i).split('"').length%2==0){t.lineExpression=e.substring(0,i),t.lineComment=e.substring(i).substring(1);break}t.lineExpression=e}return t}return t.lineExpression=e,t},e.exports.extractIndentation=function(e,t){for(var i=[],n=0,s=0,o=0,r=0;r<=e.length;r++)if("."===e[r])0!==n&&(o=r,i.push(e.substring(s,o))),s=r+1,n++;else{if("."!==e[r]&&" "!==e[r]&&"\t"!==e[r]){0!==n&&(o=r,i.push(e.substring(s,o)),t.lineExpression=e.substring(r));break}if(r===e.length-1){o=r+1,i.push(e.substring(s,o)),t.lineExpression=e.substring(r+1);break}}return i.length>0?t.lineIndentationArray=i:t.lineExpression=e,t},e.exports.splitRoutinesAndArguments=n,e.exports.extractPostConditional=s,e.exports.extractRoutines=function(e,t){for(var i={},o=[],r=n(e),a=0;a<r.length;){if(a%2==0)i.mRoutine=r[a];else{i.mArguments=r[a];for(var c=a+1;c<r.length&&""===r[c];)r.splice(c,1),i.mArguments=i.mArguments+" ";o.push(i),i={}}r.length%2!=0&&r.length>0&&a===r.length-1&&(i.mRoutine=r[a],o.push(i),i={}),a++}var p=s(o);return p.length>0&&(t.lineRoutines=p),t}},function(e,t,i){"use strict";e.exports.appendLabel=function(e,t){return e.lineLabel&&(t+=e.lineLabel),e.lineLeadSpace&&(t+=e.lineLeadSpace),t},e.exports.appendIndentation=function(e,t){var i="";if(e.lineIndentationArray&&e.lineIndentationArray.length>0){for(var n in e.lineIndentationArray)i=i+"."+e.lineIndentationArray[n];t+=i}return t},e.exports.appendRoutines=function(e,t){if(e.lineRoutines)for(var i in e.lineRoutines)(e.lineRoutines[i].mRoutine||""===e.lineRoutines[i].mRoutine)&&("0"===i?t+=e.lineRoutines[i].mRoutine:t=t+" "+e.lineRoutines[i].mRoutine,e.lineRoutines[i].mPostConditional&&(t=t+":"+e.lineRoutines[i].mPostConditional),e.lineRoutines[i].hasOwnProperty("mArguments")&&(t=t+" "+e.lineRoutines[i].mArguments));return t},e.exports.appendComment=function(e,t){return e.hasOwnProperty("lineComment")&&(t=t+";"+e.lineComment),t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),s=i(10),o=Object.values(s.TokenType),r=new n.SemanticTokensLegend(o,["standard"]);t.SemanticTokens=r;const a=new s.MumpsLineParser,c={provideDocumentSemanticTokens(e){const t=e.getText(),i=a.analyzeLines(t),s=new n.SemanticTokensBuilder(r);for(let e=0;e<i.length;e++){let t=i[e];for(let i=0;i<t.length;i++){let o=t[i],r=o.type;"exfunction"===r&&(o.position-=2,o.name="$$"+o.name),o.position<0&&console.log(t),s.push(new n.Range(new n.Position(e,o.position),new n.Position(e,o.position+o.name.length)),r,["standard"])}}return s.build()}};t.MumpsHighlighter=c}]);
//# sourceMappingURL=extension.js.map