module.exports=function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=7)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(10),i=s(1),o=s(5),r=s(11);t.Source=class{constructor(e,t,s=0,n,i){this.name=e,this.path=t,this.sourceReference=s,n&&(this.origin=n),i&&(this.adapterData=i)}};t.Scope=class{constructor(e,t,s=!1){this.name=e,this.variablesReference=t,this.expensive=s}};t.StackFrame=class{constructor(e,t,s,n=0,i=0){this.id=e,this.source=s,this.line=n,this.column=i,this.name=t}};t.Thread=class{constructor(e,t){this.id=e,this.name=t||"Thread #"+e}};t.Variable=class{constructor(e,t,s=0,n,i){this.name=e,this.value=t,this.variablesReference=s,"number"==typeof i&&(this.namedVariables=i),"number"==typeof n&&(this.indexedVariables=n)}};t.Breakpoint=class{constructor(e,t,s,n){this.verified=e;const i=this;"number"==typeof t&&(i.line=t),"number"==typeof s&&(i.column=s),n&&(i.source=n)}};t.Module=class{constructor(e,t){this.id=e,this.name=t}};t.CompletionItem=class{constructor(e,t,s=0){this.label=e,this.start=t,this.length=s}};class a extends i.Event{constructor(e,t,s){super("stopped"),this.body={reason:e},"number"==typeof t&&(this.body.threadId=t),"string"==typeof s&&(this.body.text=s)}}t.StoppedEvent=a;class u extends i.Event{constructor(e,t){super("continued"),this.body={threadId:e},"boolean"==typeof t&&(this.body.allThreadsContinued=t)}}t.ContinuedEvent=u;class c extends i.Event{constructor(){super("initialized")}}t.InitializedEvent=c;class h extends i.Event{constructor(e){if(super("terminated"),"boolean"==typeof e||e){this.body={restart:e}}}}t.TerminatedEvent=h;class l extends i.Event{constructor(e,t="console",s){super("output"),this.body={category:t,output:e},void 0!==s&&(this.body.data=s)}}t.OutputEvent=l;class d extends i.Event{constructor(e,t){super("thread"),this.body={reason:e,threadId:t}}}t.ThreadEvent=d;class p extends i.Event{constructor(e,t){super("breakpoint"),this.body={reason:e,breakpoint:t}}}t.BreakpointEvent=p;class m extends i.Event{constructor(e,t){super("module"),this.body={reason:e,module:t}}}t.ModuleEvent=m;class g extends i.Event{constructor(e,t){super("loadedSource"),this.body={reason:e,source:t}}}t.LoadedSourceEvent=g;class _ extends i.Event{constructor(e){super("capabilities"),this.body={capabilities:e}}}var b;t.CapabilitiesEvent=_,function(e){e[e.User=1]="User",e[e.Telemetry=2]="Telemetry"}(b=t.ErrorDestination||(t.ErrorDestination={}));class f extends n.ProtocolServer{constructor(e,t){super();const s="boolean"==typeof e&&e;this._debuggerLinesStartAt1=s,this._debuggerColumnsStartAt1=s,this._debuggerPathsAreURIs=!1,this._clientLinesStartAt1=!0,this._clientColumnsStartAt1=!0,this._clientPathsAreURIs=!1,this._isServer="boolean"==typeof t&&t,this.on("close",()=>{this.shutdown()}),this.on("error",e=>{this.shutdown()})}setDebuggerPathFormat(e){this._debuggerPathsAreURIs="path"!==e}setDebuggerLinesStartAt1(e){this._debuggerLinesStartAt1=e}setDebuggerColumnsStartAt1(e){this._debuggerColumnsStartAt1=e}setRunAsServer(e){this._isServer=e}static run(e){let t=0;if(process.argv.slice(2).forEach((function(e,s,n){const i=/^--server=(\d{4,5})$/.exec(e);i&&(t=parseInt(i[1],10))})),t>0)console.error(`waiting for debug protocol on port ${t}`),o.createServer(t=>{console.error(">> accepted connection from client"),t.on("end",()=>{console.error(">> client connection closed\n")});const s=new e(!1,!0);s.setRunAsServer(!0),s.start(t,t)}).listen(t);else{const t=new e(!1);process.on("SIGTERM",()=>{t.shutdown()}),t.start(process.stdin,process.stdout)}}shutdown(){this._isServer||this._isRunningInline()||setTimeout(()=>{process.exit(0)},100)}sendErrorResponse(e,t,s,n,i=b.User){let o;"number"==typeof t?(o={id:t,format:s},n&&(o.variables=n),i&b.User&&(o.showUser=!0),i&b.Telemetry&&(o.sendTelemetry=!0)):o=t,e.success=!1,e.message=f.formatPII(o.format,!0,o.variables),e.body||(e.body={}),e.body.error=o,this.sendResponse(e)}runInTerminalRequest(e,t,s){this.sendRequest("runInTerminal",e,t,s)}dispatchRequest(e){const t=new i.Response(e);try{if("initialize"===e.command){var s=e.arguments;if("boolean"==typeof s.linesStartAt1&&(this._clientLinesStartAt1=s.linesStartAt1),"boolean"==typeof s.columnsStartAt1&&(this._clientColumnsStartAt1=s.columnsStartAt1),"path"!==s.pathFormat)this.sendErrorResponse(t,2018,"debug adapter only supports native paths",null,b.Telemetry);else{const e=t;e.body={},this.initializeRequest(e,s)}}else"launch"===e.command?this.launchRequest(t,e.arguments,e):"attach"===e.command?this.attachRequest(t,e.arguments,e):"disconnect"===e.command?this.disconnectRequest(t,e.arguments,e):"terminate"===e.command?this.terminateRequest(t,e.arguments,e):"restart"===e.command?this.restartRequest(t,e.arguments,e):"setBreakpoints"===e.command?this.setBreakPointsRequest(t,e.arguments,e):"setFunctionBreakpoints"===e.command?this.setFunctionBreakPointsRequest(t,e.arguments,e):"setExceptionBreakpoints"===e.command?this.setExceptionBreakPointsRequest(t,e.arguments,e):"configurationDone"===e.command?this.configurationDoneRequest(t,e.arguments,e):"continue"===e.command?this.continueRequest(t,e.arguments,e):"next"===e.command?this.nextRequest(t,e.arguments,e):"stepIn"===e.command?this.stepInRequest(t,e.arguments,e):"stepOut"===e.command?this.stepOutRequest(t,e.arguments,e):"stepBack"===e.command?this.stepBackRequest(t,e.arguments,e):"reverseContinue"===e.command?this.reverseContinueRequest(t,e.arguments,e):"restartFrame"===e.command?this.restartFrameRequest(t,e.arguments,e):"goto"===e.command?this.gotoRequest(t,e.arguments,e):"pause"===e.command?this.pauseRequest(t,e.arguments,e):"stackTrace"===e.command?this.stackTraceRequest(t,e.arguments,e):"scopes"===e.command?this.scopesRequest(t,e.arguments,e):"variables"===e.command?this.variablesRequest(t,e.arguments,e):"setVariable"===e.command?this.setVariableRequest(t,e.arguments,e):"setExpression"===e.command?this.setExpressionRequest(t,e.arguments,e):"source"===e.command?this.sourceRequest(t,e.arguments,e):"threads"===e.command?this.threadsRequest(t,e):"terminateThreads"===e.command?this.terminateThreadsRequest(t,e.arguments,e):"evaluate"===e.command?this.evaluateRequest(t,e.arguments,e):"stepInTargets"===e.command?this.stepInTargetsRequest(t,e.arguments,e):"gotoTargets"===e.command?this.gotoTargetsRequest(t,e.arguments,e):"completions"===e.command?this.completionsRequest(t,e.arguments,e):"exceptionInfo"===e.command?this.exceptionInfoRequest(t,e.arguments,e):"loadedSources"===e.command?this.loadedSourcesRequest(t,e.arguments,e):"dataBreakpointInfo"===e.command?this.dataBreakpointInfoRequest(t,e.arguments,e):"setDataBreakpoints"===e.command?this.setDataBreakpointsRequest(t,e.arguments,e):"readMemory"===e.command?this.readMemoryRequest(t,e.arguments,e):"disassemble"===e.command?this.disassembleRequest(t,e.arguments,e):"cancel"===e.command?this.cancelRequest(t,e.arguments,e):"breakpointLocations"===e.command?this.breakpointLocationsRequest(t,e.arguments,e):this.customRequest(e.command,t,e.arguments,e)}catch(e){this.sendErrorResponse(t,1104,"{_stack}",{_exception:e.message,_stack:e.stack},b.Telemetry)}}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,e.body.supportsRestartRequest=!1,e.body.supportsExceptionOptions=!1,e.body.supportsValueFormattingOptions=!1,e.body.supportsExceptionInfoRequest=!1,e.body.supportTerminateDebuggee=!1,e.body.supportsDelayedStackTraceLoading=!1,e.body.supportsLoadedSourcesRequest=!1,e.body.supportsLogPoints=!1,e.body.supportsTerminateThreadsRequest=!1,e.body.supportsSetExpression=!1,e.body.supportsTerminateRequest=!1,e.body.supportsDataBreakpoints=!1,e.body.supportsReadMemoryRequest=!1,e.body.supportsDisassembleRequest=!1,e.body.supportsCancelRequest=!1,e.body.supportsBreakpointLocationsRequest=!1,this.sendResponse(e)}disconnectRequest(e,t,s){this.sendResponse(e),this.shutdown()}launchRequest(e,t,s){this.sendResponse(e)}attachRequest(e,t,s){this.sendResponse(e)}terminateRequest(e,t,s){this.sendResponse(e)}restartRequest(e,t,s){this.sendResponse(e)}setBreakPointsRequest(e,t,s){this.sendResponse(e)}setFunctionBreakPointsRequest(e,t,s){this.sendResponse(e)}setExceptionBreakPointsRequest(e,t,s){this.sendResponse(e)}configurationDoneRequest(e,t,s){this.sendResponse(e)}continueRequest(e,t,s){this.sendResponse(e)}nextRequest(e,t,s){this.sendResponse(e)}stepInRequest(e,t,s){this.sendResponse(e)}stepOutRequest(e,t,s){this.sendResponse(e)}stepBackRequest(e,t,s){this.sendResponse(e)}reverseContinueRequest(e,t,s){this.sendResponse(e)}restartFrameRequest(e,t,s){this.sendResponse(e)}gotoRequest(e,t,s){this.sendResponse(e)}pauseRequest(e,t,s){this.sendResponse(e)}sourceRequest(e,t,s){this.sendResponse(e)}threadsRequest(e,t){this.sendResponse(e)}terminateThreadsRequest(e,t,s){this.sendResponse(e)}stackTraceRequest(e,t,s){this.sendResponse(e)}scopesRequest(e,t,s){this.sendResponse(e)}variablesRequest(e,t,s){this.sendResponse(e)}setVariableRequest(e,t,s){this.sendResponse(e)}setExpressionRequest(e,t,s){this.sendResponse(e)}evaluateRequest(e,t,s){this.sendResponse(e)}stepInTargetsRequest(e,t,s){this.sendResponse(e)}gotoTargetsRequest(e,t,s){this.sendResponse(e)}completionsRequest(e,t,s){this.sendResponse(e)}exceptionInfoRequest(e,t,s){this.sendResponse(e)}loadedSourcesRequest(e,t,s){this.sendResponse(e)}dataBreakpointInfoRequest(e,t,s){this.sendResponse(e)}setDataBreakpointsRequest(e,t,s){this.sendResponse(e)}readMemoryRequest(e,t,s){this.sendResponse(e)}disassembleRequest(e,t,s){this.sendResponse(e)}cancelRequest(e,t,s){this.sendResponse(e)}breakpointLocationsRequest(e,t,s){this.sendResponse(e)}customRequest(e,t,s,n){this.sendErrorResponse(t,1014,"unrecognized request",null,b.Telemetry)}convertClientLineToDebugger(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e+1:this._clientLinesStartAt1?e-1:e}convertDebuggerLineToClient(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e-1:this._clientLinesStartAt1?e+1:e}convertClientColumnToDebugger(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e+1:this._clientColumnsStartAt1?e-1:e}convertDebuggerColumnToClient(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e-1:this._clientColumnsStartAt1?e+1:e}convertClientPathToDebugger(e){return this._clientPathsAreURIs!==this._debuggerPathsAreURIs?this._clientPathsAreURIs?f.uri2path(e):f.path2uri(e):e}convertDebuggerPathToClient(e){return this._debuggerPathsAreURIs!==this._clientPathsAreURIs?this._debuggerPathsAreURIs?f.uri2path(e):f.path2uri(e):e}static path2uri(e){"win32"===process.platform&&(/^[A-Z]:/.test(e)&&(e=e[0].toLowerCase()+e.substr(1)),e=e.replace(/\\/g,"/")),e=encodeURI(e);let t=new r.URL("file:");return t.pathname=e,t.toString()}static uri2path(e){let t=new r.URL(e),s=decodeURIComponent(t.pathname);return"win32"===process.platform&&(/^\/[a-zA-Z]:/.test(s)&&(s=s[1].toLowerCase()+s.substr(2)),s=s.replace(/\//g,"\\")),s}static formatPII(e,t,s){return e.replace(f._formatPIIRegexp,(function(e,n){return t&&n.length>0&&"_"!==n[0]?e:s[n]&&s.hasOwnProperty(n)?s[n]:e}))}}f._formatPIIRegexp=/{([^}]+)}/g,t.DebugSession=f},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e){this.seq=0,this.type=e}}t.Message=n;t.Response=class extends n{constructor(e,t){super("response"),this.request_seq=e.seq,this.command=e.command,t?(this.success=!1,this.message=t):this.success=!0}};t.Event=class extends n{constructor(e,t){super("event"),this.event=e,t&&(this.body=t)}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("net")},function(e,t,s){"use strict";var n=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))((function(i,o){function r(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new s((function(t){t(e.value)})).then(r,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=s(2),o=s(3),r=s(13),a=s(0);var u;!function(e){e[e.Verbose=0]="Verbose",e[e.Log=1]="Log",e[e.Warn=2]="Warn",e[e.Error=3]="Error",e[e.Stop=4]="Stop"}(u=t.LogLevel||(t.LogLevel={}));class c{constructor(){this._pendingLogQ=[]}log(e,t=u.Log){e+="\n",this._write(e,t)}verbose(e){this.log(e,u.Verbose)}warn(e){this.log(e,u.Warn)}error(e){this.log(e,u.Error)}dispose(){if(this._currentLogger){const e=this._currentLogger.dispose();return this._currentLogger=null,e}return Promise.resolve()}_write(e,t=u.Log){e+="",this._pendingLogQ?this._pendingLogQ.push({msg:e,level:t}):this._currentLogger&&this._currentLogger.log(e,t)}setup(e,t,s=!0){const n="string"==typeof t?t:t&&this._logFilePathFromInit;if(this._currentLogger){const t={consoleMinLogLevel:e,logFilePath:n,prependTimestamp:s};this._currentLogger.setup(t).then(()=>{if(this._pendingLogQ){const e=this._pendingLogQ;this._pendingLogQ=null,e.forEach(e=>this._write(e.msg,e.level))}})}}init(e,t,s){this._pendingLogQ=this._pendingLogQ||[],this._currentLogger=new h(e,s),this._logFilePathFromInit=t}}t.Logger=c,t.logger=new c;class h{constructor(e,t){this.beforeExitCallback=()=>this.dispose(),this._logCallback=e,this._logToConsole=t,this._minLogLevel=u.Warn,this.disposeCallback=(e,t)=>{this.dispose(),t=t||2,t+=128,process.exit(t)}}setup(e){return n(this,void 0,void 0,(function*(){if(this._minLogLevel=e.consoleMinLogLevel,this._prependTimestamp=e.prependTimestamp,e.logFilePath)if(o.isAbsolute(e.logFilePath)){const s=t=>this.sendLog(`Error creating log file at path: ${e.logFilePath}. Error: ${t.toString()}\n`,u.Error);try{yield(t=o.dirname(e.logFilePath),new Promise((e,s)=>{r(t,t=>{t?s(t):e()})})),this.log("Verbose logs are written to:\n",u.Warn),this.log(e.logFilePath+"\n",u.Warn),this._logFileStream=i.createWriteStream(e.logFilePath),this.logDateTime(),this.setupShutdownListeners(),this._logFileStream.on("error",e=>{s(e)})}catch(e){s(e)}}else this.log(`logFilePath must be an absolute path: ${e.logFilePath}`,u.Error);var t}))}logDateTime(){let e=new Date;const t=e.getUTCFullYear()+"-"+`${e.getUTCMonth()+1}`+"-"+e.getUTCDate()+", "+p();this.log(t+"\n",u.Verbose,!1)}setupShutdownListeners(){process.addListener("beforeExit",this.beforeExitCallback),process.addListener("SIGTERM",this.disposeCallback),process.addListener("SIGINT",this.disposeCallback)}removeShutdownListeners(){process.removeListener("beforeExit",this.beforeExitCallback),process.removeListener("SIGTERM",this.disposeCallback),process.removeListener("SIGINT",this.disposeCallback)}dispose(){return new Promise(e=>{this.removeShutdownListeners(),this._logFileStream?(this._logFileStream.end(e),this._logFileStream=null):e()})}log(e,t,s=!0){if(this._minLogLevel!==u.Stop){if(t>=this._minLogLevel&&this.sendLog(e,t),this._logToConsole){const s=t===u.Error?console.error:t===u.Warn?console.warn:null;s&&s(d(e))}t===u.Error&&(e=`[${u[t]}] ${e}`),this._prependTimestamp&&s&&(e="["+p()+"] "+e),this._logFileStream&&this._logFileStream.write(e)}}sendLog(e,t){if(e.length>1500){const t=!!e.match(/(\n|\r\n)$/);e=e.substr(0,1500)+"[...]",t&&(e+="\n")}if(this._logCallback){const s=new l(e,t);this._logCallback(s)}}}class l extends a.OutputEvent{constructor(e,t){super(e,t===u.Error?"stderr":t===u.Warn?"console":"stdout")}}function d(e){return e.replace(/(\n|\r\n)$/,"")}function p(){let e=new Date;return m(2,String(e.getUTCHours()))+":"+m(2,String(e.getUTCMinutes()))+":"+m(2,String(e.getUTCSeconds()))+"."+m(3,String(e.getUTCMilliseconds()))+" UTC"}function m(e,t){return t.length>=e?t:String("0".repeat(e)+t).slice(-e)}t.LogOutputEvent=l,t.trimLastNewline=d},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(8);n.MumpsDebugSession.run(n.MumpsDebugSession)},function(e,t,s){"use strict";var n=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))((function(i,o){function r(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new s((function(t){t(e.value)})).then(r,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=s(9),o=s(3),{Subject:r}=s(15),a=s(16);class u extends i.LoggingDebugSession{constructor(){super("mumps-debug.txt"),this._variableHandles=new i.Handles,this._configurationDone=new r,this.setDebuggerLinesStartAt1(!1),this.setDebuggerColumnsStartAt1(!1),this._mconnect=new a.MConnect,this._mconnect.on("stopOnEntry",()=>{this.sendEvent(new i.StoppedEvent("entry",u.THREAD_ID))}),this._mconnect.on("stopOnStep",()=>{this.sendEvent(new i.StoppedEvent("step",u.THREAD_ID))}),this._mconnect.on("stopOnBreakpoint",()=>{this.sendEvent(new i.StoppedEvent("breakpoint",u.THREAD_ID))}),this._mconnect.on("stopOnDataBreakpoint",()=>{this.sendEvent(new i.StoppedEvent("data breakpoint",u.THREAD_ID))}),this._mconnect.on("stopOnException",()=>{this.sendEvent(new i.StoppedEvent("exception",u.THREAD_ID))}),this._mconnect.on("breakpointValidated",e=>{this.sendEvent(new i.BreakpointEvent("changed",{verified:e.verified,id:e.id}))}),this._mconnect.on("output",(e,t,s,n)=>{const o=new i.OutputEvent(`${e}\n`);o.body.source=this.createSource(t),o.body.line=this.convertDebuggerLineToClient(s),o.body.column=this.convertDebuggerColumnToClient(n),this.sendEvent(o)}),this._mconnect.on("end",()=>{this.sendEvent(new i.TerminatedEvent)})}initializeRequest(e,t){e.body=e.body||{},e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!0,e.body.supportsStepBack=!1,e.body.supportsDataBreakpoints=!1,e.body.supportsCompletionsRequest=!1,e.body.completionTriggerCharacters=[".","["],e.body.supportsCancelRequest=!1,e.body.supportsBreakpointLocationsRequest=!0,this.sendResponse(e),this.sendEvent(new i.InitializedEvent)}configurationDoneRequest(e,t){super.configurationDoneRequest(e,t),this._configurationDone.notify()}launchRequest(e,t){return n(this,void 0,void 0,(function*(){i.logger.setup(t.trace?i.Logger.LogLevel.Verbose:i.Logger.LogLevel.Stop,!1),yield this._configurationDone.wait(1e3),this._mconnect.init(t.hostname,t.port,t.localRoutinesPath).then(()=>n(this,void 0,void 0,(function*(){this._mconnect.start(t.program,!!t.stopOnEntry),this.sendResponse(e)}))).catch(e=>{console.log(e)})}))}setBreakPointsRequest(e,t){const s=t.source.path,n=t.lines||[];this._mconnect.clearBreakpoints(s);const o=n.map(e=>{let{verified:t,line:n,id:o}=this._mconnect.setBreakPoint(s,this.convertClientLineToDebugger(e));const r=new i.Breakpoint(t,this.convertDebuggerLineToClient(n));return r.id=o,r});this._mconnect.requestBreakpoints(),e.body={breakpoints:o},this.sendResponse(e)}threadsRequest(e){e.body={threads:[new i.Thread(u.THREAD_ID,"thread 1")]},this.sendResponse(e)}stackTraceRequest(e,t){const s="number"==typeof t.startFrame?t.startFrame:0,n=s+("number"==typeof t.levels?t.levels:1e3),o=this._mconnect.stack(s,n);e.body={stackFrames:o.frames.map(e=>new i.StackFrame(e.index,e.name,this.createSource(e.file),this.convertDebuggerLineToClient(e.line))),totalFrames:o.count},this.sendResponse(e)}scopesRequest(e,t){e.body={scopes:[new i.Scope("Local",this._variableHandles.create("local|0"),!0),new i.Scope("System",this._variableHandles.create("system"),!1)]},this.sendResponse(e)}variablesRequest(e,t,s){return n(this,void 0,void 0,(function*(){const s=[];let n;const i=this._variableHandles.get(t.variablesReference);if("system"===i){let e=this._mconnect.getVariables("system");for(let t in e)s.push({name:t,type:"string",value:e[t],variablesReference:0})}else{const e=i.split("|"),t=parseInt(e.pop()),o=e.join("|");let r,a=this._mconnect.getVariables("local"),u=!0,c="";for(let e in a){let i=this.varAnalyze(e,a[e]);u?(r=i,u=!1):((n=this.checkVars(r,i,t,o,c))&&(0!==n.variablesReference&&(c=r.bases[t]),s.push(n)),r=i)}if(!u){const e={name:"",indexCount:0,bases:[],content:""};(n=this.checkVars(r,e,t,o,c))&&s.push(n)}}e.body={variables:s},this.sendResponse(e)}))}checkVars(e,t,s,n,i){let o=void 0,r=0;if(0===s||e.bases[s-1]===n&&e.indexCount>s)if(e.indexCount>s+1){if(i!==e.bases[s]){let e=t.bases[s];s>0&&(e+=")"),o={name:e,type:"string",value:"undefined",variablesReference:this._variableHandles.create(t.bases[s]+"|"+(s+1))}}}else e.bases[s]===t.bases[s]&&(r=this._variableHandles.create(e.bases[s]+"|"+(s+1))),o={name:e.name,type:"string",value:e.content,variablesReference:r};return o}continueRequest(e,t){this._mconnect.continue(),this.sendResponse(e)}nextRequest(e,t){this._mconnect.step("OVER"),this.sendResponse(e)}stepInRequest(e,t,s){this._mconnect.step("INTO"),this.sendResponse(e)}stepOutRequest(e,t,s){this._mconnect.step("OUTOF")}evaluateRequest(e,t){let s="";"hover"===t.context&&(s=t.expression+":= "+this._mconnect.getSingleVar(t.expression)),e.body={result:s,variablesReference:0},this.sendResponse(e)}disconnectRequest(e,t,s){this._mconnect.disconnect(),this.sendResponse(e)}createSource(e){return new i.Source(o.basename(e),this.convertDebuggerPathToClient(e),void 0,void 0,"mock-adapter-data")}varAnalyze(e,t){let s=1,n=[],i=e.length,o=e.indexOf("("),r=!0;if(o>0){n.push(e.substring(0,o)),s++;for(let t=o;t<i;t++)","===e.substring(t,t+1)&&r&&(n.push(e.substring(0,t)),s++),'"'===e.substring(t,t+1)&&(r=!r);n.push(e.substring(0,e.length-1))}else n.push(e);return{name:e,indexCount:s,bases:n,content:t}}}u.THREAD_ID=1,t.MumpsDebugSession=u},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.DebugSession=n.DebugSession,t.InitializedEvent=n.InitializedEvent,t.TerminatedEvent=n.TerminatedEvent,t.StoppedEvent=n.StoppedEvent,t.ContinuedEvent=n.ContinuedEvent,t.OutputEvent=n.OutputEvent,t.ThreadEvent=n.ThreadEvent,t.BreakpointEvent=n.BreakpointEvent,t.ModuleEvent=n.ModuleEvent,t.LoadedSourceEvent=n.LoadedSourceEvent,t.CapabilitiesEvent=n.CapabilitiesEvent,t.Thread=n.Thread,t.StackFrame=n.StackFrame,t.Scope=n.Scope,t.Variable=n.Variable,t.Breakpoint=n.Breakpoint,t.Source=n.Source,t.Module=n.Module,t.CompletionItem=n.CompletionItem,t.ErrorDestination=n.ErrorDestination;const i=s(12);t.LoggingDebugSession=i.LoggingDebugSession;const o=s(6);t.Logger=o;const r=s(1);t.Event=r.Event,t.Response=r.Response;const a=s(14);t.Handles=a.Handles;const u=o.logger;t.logger=u},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(4),i=s(1);class o{get event(){return this._event||(this._event=(e,t)=>{let s;return this._listener=e,this._this=t,s={dispose:()=>{this._listener=void 0,this._this=void 0}},s}),this._event}fire(e){if(this._listener)try{this._listener.call(this._this,e)}catch(e){}}hasListener(){return!!this._listener}dispose(){this._listener=void 0,this._this=void 0}}class r extends n.EventEmitter{constructor(){super(),this._sendMessage=new o,this._pendingRequests=new Map,this.onDidSendMessage=this._sendMessage.event}dispose(){}handleMessage(e){if("request"===e.type)this.dispatchRequest(e);else if("response"===e.type){const t=e,s=this._pendingRequests.get(t.request_seq);s&&(this._pendingRequests.delete(t.request_seq),s(t))}}_isRunningInline(){return this._sendMessage&&this._sendMessage.hasListener()}start(e,t){this._sequence=1,this._writableStream=t,this._rawData=new Buffer(0),e.on("data",e=>this._handleData(e)),e.on("close",()=>{this._emitEvent(new i.Event("close"))}),e.on("error",e=>{this._emitEvent(new i.Event("error","inStream error: "+(e&&e.message)))}),t.on("error",e=>{this._emitEvent(new i.Event("error","outStream error: "+(e&&e.message)))}),e.resume()}stop(){this._writableStream&&this._writableStream.end()}sendEvent(e){this._send("event",e)}sendResponse(e){e.seq>0?console.error(`attempt to send more than one response for command ${e.command}`):this._send("response",e)}sendRequest(e,t,s,n){const o={command:e};if(t&&Object.keys(t).length>0&&(o.arguments=t),this._writableStream){if(this._send("request",o),n){this._pendingRequests.set(o.seq,n);const e=setTimeout(()=>{clearTimeout(e);const t=this._pendingRequests.get(o.seq);t&&(this._pendingRequests.delete(o.seq),t(new i.Response(o,"timeout")))},s)}}else this._emitEvent(new i.Event("error","sendRequest: No writableStream"))}dispatchRequest(e){}_emitEvent(e){this.emit(e.event,e)}_send(e,t){if(t.type=e,t.seq=this._sequence++,this._writableStream){const e=JSON.stringify(t);this._writableStream.write(`Content-Length: ${Buffer.byteLength(e,"utf8")}\r\n\r\n${e}`,"utf8")}this._sendMessage.fire(t)}_handleData(e){for(this._rawData=Buffer.concat([this._rawData,e]);;){if(this._contentLength>=0){if(this._rawData.length>=this._contentLength){const e=this._rawData.toString("utf8",0,this._contentLength);if(this._rawData=this._rawData.slice(this._contentLength),this._contentLength=-1,e.length>0)try{let t=JSON.parse(e);this.handleMessage(t)}catch(e){this._emitEvent(new i.Event("error","Error handling data: "+(e&&e.message)))}continue}}else{const e=this._rawData.indexOf(r.TWO_CRLF);if(-1!==e){const t=this._rawData.toString("utf8",0,e).split("\r\n");for(let e=0;e<t.length;e++){const s=t[e].split(/: +/);"Content-Length"==s[0]&&(this._contentLength=+s[1])}this._rawData=this._rawData.slice(e+r.TWO_CRLF.length);continue}}break}}}r.TWO_CRLF="\r\n\r\n",t.ProtocolServer=r},function(e,t){e.exports=require("url")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(6),i=n.logger,o=s(0);class r extends o.DebugSession{constructor(e,t,s){super(t,s),this.obsolete_logFilePath=e,this.on("error",e=>{i.error(e.body)})}start(e,t){super.start(e,t),i.init(e=>this.sendEvent(e),this.obsolete_logFilePath,this._isServer)}sendEvent(e){if(!(e instanceof n.LogOutputEvent)){let t=e;e instanceof o.OutputEvent&&e.body&&e.body.data&&e.body.data.doNotLogOutput&&(delete e.body.data.doNotLogOutput,t=Object.assign({},e),t.body=Object.assign({},e.body,{output:"<output not logged>"})),i.verbose(`To client: ${JSON.stringify(t)}`)}super.sendEvent(e)}sendRequest(e,t,s,n){i.verbose(`To client: ${JSON.stringify(e)}(${JSON.stringify(t)}), timeout: ${s}`),super.sendRequest(e,t,s,n)}sendResponse(e){i.verbose(`To client: ${JSON.stringify(e)}`),super.sendResponse(e)}dispatchRequest(e){i.verbose(`From client: ${e.command}(${JSON.stringify(e.arguments)})`),super.dispatchRequest(e)}}t.LoggingDebugSession=r},function(e,t,s){var n=s(3),i=s(2),o=parseInt("0777",8);function r(e,t,s,a){"function"==typeof t?(s=t,t={}):t&&"object"==typeof t||(t={mode:t});var u=t.mode,c=t.fs||i;void 0===u&&(u=o&~process.umask()),a||(a=null);var h=s||function(){};e=n.resolve(e),c.mkdir(e,u,(function(s){if(!s)return h(null,a=a||e);switch(s.code){case"ENOENT":r(n.dirname(e),t,(function(s,n){s?h(s,n):r(e,t,h,n)}));break;default:c.stat(e,(function(e,t){e||!t.isDirectory()?h(s,a):h(null,a)}))}}))}e.exports=r.mkdirp=r.mkdirP=r,r.sync=function e(t,s,r){s&&"object"==typeof s||(s={mode:s});var a=s.mode,u=s.fs||i;void 0===a&&(a=o&~process.umask()),r||(r=null),t=n.resolve(t);try{u.mkdirSync(t,a),r=r||t}catch(i){switch(i.code){case"ENOENT":r=e(n.dirname(t),s,r),e(t,s,r);break;default:var c;try{c=u.statSync(t)}catch(e){throw i}if(!c.isDirectory())throw i}}return r}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Handles=class{constructor(e){this.START_HANDLE=1e3,this._handleMap=new Map,this._nextHandle="number"==typeof e?e:this.START_HANDLE}reset(){this._nextHandle=this.START_HANDLE,this._handleMap=new Map}create(e){var t=this._nextHandle++;return this._handleMap.set(t,e),t}get(e,t){return this._handleMap.get(e)||t}}},function(e,t){function s(){this.waiters=[]}s.prototype.wait=function(e){var t=this,s={};this.waiters.push(s);var n=new Promise((function(e){var n=!1;s.resolve=function(i){if(!n){if(n=!0,s.timeout&&(clearTimeout(s.timeout),s.timeout=null),!i){var o=t.waiters.indexOf(s);o>-1&&t.waiters.splice(o,1)}e()}}}));return e>0&&isFinite(e)&&(s.timeout=setTimeout((function(){s.timeout=null,s.resolve()}),e)),n},s.prototype.notify=function(){this.waiters.length>0&&this.waiters.pop().resolve(!0)},s.prototype.notifyAll=function(){for(var e=this.waiters.length-1;e>=0;e--)this.waiters[e].resolve(!0);this.waiters=[]},t.Subject=s},function(e,t,s){"use strict";var n=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))((function(i,o){function r(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new s((function(t){t(e.value)})).then(r,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=s(5),o=s(4),r=s(2);class a extends o.EventEmitter{constructor(){super(),this.event=new o.EventEmitter,this._currentLine=0,this._breakpointId=1,this._logging=!0,this._connectState="waitingforStart",this._readedData="",this._mVars={},this._mStack=[],this._commandQueue=[],this._activeBreakpoints=[],this._breakPoints=[],this.event.on("varsComplete",()=>{if(void 0!==this._mVars.I){let e=this._mVars.I;this.checkEvents(e.$ZPOSITION,e.$ZSTATUS)}})}init(e,t,s){return n(this,void 0,void 0,(function*(){const n=new i.Socket;return this._localRoutinesPath=s,this._hostname=e,this._port=t,new Promise((e,t)=>{n.connect(this._port,this._hostname,()=>{this._socket=n,console.log("Debug-Server connected\n"),n.on("data",e=>{this._readedData+=e.toString();let t=this._readedData.indexOf("\n");for(;-1!==t;)this.processLine(this._readedData.substring(0,t)),this._readedData=this._readedData.substring(t+1),t=this._readedData.indexOf("\n")}),e(n)}),n.on("error",e=>{t(e)})})}))}_log(e){this._logging&&console.log(e)}processLine(e){let t,s,n;switch(this._connectState){case"waitingforStart":"***STARTVAR"===e&&(this._connectState="waitingforVars",this._mStack=[],this._mVars={}),"***STARTBP"===e&&(this._connectState="waitingforBreakpoints",this._activeBreakpoints=[],this._log(e));break;case"waitingforVars":if("***ENDVAR"===e)this._connectState="waitingforStart",this.event.emit("varsComplete");else{for(n=e.substring(0,1),"S"===n&&this._mStack.push(e.substring(2)),t=e.substring(2,e.indexOf("="));(t.split('"').length-1)%2!=0;)t=e.substring(0,e.indexOf("=",t.length+1));s=e.substring(t.length+3).replace(/^"/,"").replace(/"$/,""),void 0===this._mVars[n]&&(this._mVars[n]={}),this._mVars[n][t]=s}break;case"waitingforBreakpoints":"***ENDBP"===e?(this._log(e),this._connectState="waitingforStart",this.verifyBreakpoints()):(this._log(e),this._activeBreakpoints.push(e));break;default:console.log("Unexpected Message: "+e)}}writeln(e){if(this._commandQueue.push(e),this._commandQueue.length>1e3)throw console.log("Too many Commands in Queue Check Debugger Connection"),new Error;if(this._socket)for(;this._commandQueue.length;)e=this._commandQueue.shift(),this._log(e),this._socket.write(e+"\n")}sendBreakpoint(e,t,s){s?this.writeln("SETBP;"+e+";"+t):this.writeln("CLEARBP;"+e+";"+t)}start(e,t){t&&this.sendBreakpoint(e,1,!0),this.requestBreakpoints(),this.writeln("START;"+e)}step(e){this.writeln(e)}continue(){this.writeln("CONTINUE")}disconnect(){this.writeln("RESET")}requestBreakpoints(){this.writeln("REQUESTBP")}checkEvents(e,t){const s=e.split("^"),n=s[0],i=s[1],o=this._localRoutinesPath+i+".m";this.loadSource(o);const r=n.split("+")[0];let a=0;"undefined"!==n.split("+")[1]&&(a=parseInt(n.split("+")[1]));let u=0;if(""!==r)for(let e=0;e<this._sourceLines.length;e++)if(this._sourceLines[e].substring(0,r.length)===r){u=e;break}if(this._currentLine=u+a,""!==t)this.sendEvent("stopOnException");else{this._breakPoints.filter(e=>e.file===this._sourceFile&&e.line===this._currentLine).length>0?this.sendEvent("stopOnBreakpoint"):this.sendEvent("stopOnStep")}}stack(e,t){const s=new Array;for(let t=e;t<this._mStack.length;t++){const e=this._mStack[t],n=this.convertMumpsPosition(e);n.line++,s.push({index:t,name:`${e}(${t})`,file:n.file,line:n.line})}return{frames:s,count:Math.min(this._mStack.length,t)}}setBreakPoint(e,t){const s={verified:!1,file:e,line:t,id:this._breakpointId++};return this._breakPoints.push(s),this.sendBreakpoint(e,s.line+1,!0),s}clearBreakPoint(e,t){let s=this._breakPoints;if(s){const n=s.findIndex(s=>s.file===e&&s.line===t);if(n>=0){const t=s[n];return this.sendBreakpoint(e,t.line,!1),s.splice(n,1),t}}}clearBreakpoints(e){let t=this._breakPoints;t&&(t.filter(t=>t.file===e),t.forEach(t=>{this.clearBreakPoint(e,t.line)}))}verifyBreakpoints(){let e=[];this._breakPoints.forEach(t=>{t.verified=!1;for(let s=0;s<this._activeBreakpoints.length;s++){let n=this.convertMumpsPosition(this._activeBreakpoints[s]);if(n.file===t.file&&t.line===n.line){t.verified=!0,this.sendEvent("breakpointValidated",t),e[s]=!0;break}}t.verified||this.sendEvent("breakpointValidated",t)});for(let t=0;t<this._activeBreakpoints.length;t++)if(!e[t]){let e=this.convertMumpsPosition(this._activeBreakpoints[t]),s={verified:!0,file:e.file,line:e.line,id:this._breakpointId++};this.sendEvent("breakpointValidated",s)}}getVariables(e){return"system"===e?this._mVars.I:"local"===e?this._mVars.V:void 0}getSingleVar(e){return"$"===e.substring(0,1)?void 0!==this._mVars.I?this._mVars.I[e]:void 0:void 0!==this._mVars.V?this._mVars.V[e]:void 0}loadSource(e){this._sourceFile!==e&&(this._sourceFile=e,this._sourceLines=r.readFileSync(this._sourceFile).toString().split("\n"))}convertMumpsPosition(e){let t=e.split("^"),s=t[0],n=t[1].split(" ",1)[0],i=this._localRoutinesPath+n+".m",o=r.readFileSync(i).toString().split("\n"),a=s.split("+")[0],u=0;void 0!==s.split("+")[1]&&(u=parseInt(s.split("+")[1]));let c=0;if(""!==a)for(let e=0;e<o.length;e++)if(o[e].substring(0,a.length)===a){c=e;break}return{file:i,line:c+u-1}}sendEvent(e,...t){setImmediate(s=>{this.emit(e,...t)})}}t.MConnect=a}]);
//# sourceMappingURL=extension.js.map